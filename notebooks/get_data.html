<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Benton Tripp">

<title>Getting the Data - Bird Species Observations and Environmental Rasters</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="get_data_files/libs/clipboard/clipboard.min.js"></script>
<script src="get_data_files/libs/quarto-html/quarto.js"></script>
<script src="get_data_files/libs/quarto-html/popper.min.js"></script>
<script src="get_data_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="get_data_files/libs/quarto-html/anchor.min.js"></script>
<link href="get_data_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="get_data_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="get_data_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="get_data_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="get_data_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="get_data_files/libs/htmlwidgets-1.6.2/htmlwidgets.js"></script>
<script src="get_data_files/libs/jquery-1.12.4/jquery.min.js"></script>
<link href="get_data_files/libs/leaflet-1.3.1/leaflet.css" rel="stylesheet">
<script src="get_data_files/libs/leaflet-1.3.1/leaflet.js"></script>
<link href="get_data_files/libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet">
<script src="get_data_files/libs/proj4-2.6.2/proj4.min.js"></script>
<script src="get_data_files/libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="get_data_files/libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet">
<script src="get_data_files/libs/leaflet-binding-2.1.2/leaflet.js"></script>
<script src="get_data_files/libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script>
<script src="get_data_files/libs/leaflet-providers-plugin-2.1.2/leaflet-providers-plugin.js"></script>


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#data-sources" id="toc-data-sources" class="nav-link" data-scroll-target="#data-sources">Data Sources</a></li>
  <li><a href="#boundary-data" id="toc-boundary-data" class="nav-link" data-scroll-target="#boundary-data">Boundary Data</a></li>
  <li><a href="#ebird-data" id="toc-ebird-data" class="nav-link" data-scroll-target="#ebird-data">eBird Data</a></li>
  <li><a href="#observation-data-pre-processing" id="toc-observation-data-pre-processing" class="nav-link" data-scroll-target="#observation-data-pre-processing">Observation Data Pre-Processing</a></li>
  <li><a href="#rasters" id="toc-rasters" class="nav-link" data-scroll-target="#rasters">Rasters</a></li>
  <li><a href="#raster-pre-processing" id="toc-raster-pre-processing" class="nav-link" data-scroll-target="#raster-pre-processing">Raster Pre-Processing</a>
  <ul class="collapse">
  <li><a href="#general-raster-pre-processing-steps" id="toc-general-raster-pre-processing-steps" class="nav-link" data-scroll-target="#general-raster-pre-processing-steps">General Raster Pre-Processing Steps</a></li>
  <li><a href="#digital-elevation-model-dem" id="toc-digital-elevation-model-dem" class="nav-link" data-scroll-target="#digital-elevation-model-dem">Digital Elevation Model (DEM)</a></li>
  <li><a href="#urban-imperviousness" id="toc-urban-imperviousness" class="nav-link" data-scroll-target="#urban-imperviousness">Urban Imperviousness</a></li>
  <li><a href="#land-cover" id="toc-land-cover" class="nav-link" data-scroll-target="#land-cover">Land Cover</a></li>
  <li><a href="#canopy" id="toc-canopy" class="nav-link" data-scroll-target="#canopy">Canopy</a></li>
  <li><a href="#weather" id="toc-weather" class="nav-link" data-scroll-target="#weather">Weather</a></li>
  <li><a href="#hydrography-water-bodies-coasts" id="toc-hydrography-water-bodies-coasts" class="nav-link" data-scroll-target="#hydrography-water-bodies-coasts">Hydrography (Water Bodies &amp; Coasts)</a></li>
  <li><a href="#soil" id="toc-soil" class="nav-link" data-scroll-target="#soil">Soil</a></li>
  <li><a href="#vegetation-index" id="toc-vegetation-index" class="nav-link" data-scroll-target="#vegetation-index">Vegetation Index</a></li>
  <li><a href="#final-pre-processing-steps-ensuring-shapesize-conformity" id="toc-final-pre-processing-steps-ensuring-shapesize-conformity" class="nav-link" data-scroll-target="#final-pre-processing-steps-ensuring-shapesize-conformity">Final Pre-Processing Steps (Ensuring Shape/Size Conformity)</a></li>
  </ul></li>
  <li><a href="#combining-the-data-feature-extraction" id="toc-combining-the-data-feature-extraction" class="nav-link" data-scroll-target="#combining-the-data-feature-extraction">Combining the Data (Feature Extraction)</a></li>
  <li><a href="#final-output-examples" id="toc-final-output-examples" class="nav-link" data-scroll-target="#final-output-examples">Final Output Examples</a>
  <ul class="collapse">
  <li><a href="#data" id="toc-data" class="nav-link" data-scroll-target="#data">Data</a></li>
  <li><a href="#rasters-1" id="toc-rasters-1" class="nav-link" data-scroll-target="#rasters-1">Rasters</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Getting the Data - Bird Species Observations and Environmental Rasters</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Benton Tripp </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<section id="overview" class="level2">
<h2 class="anchored" data-anchor-id="overview">Overview</h2>
</section>
<section id="data-sources" class="level2">
<h2 class="anchored" data-anchor-id="data-sources">Data Sources</h2>
<ul>
<li>State Boundary Data
<ul>
<li><a href="https://hub.arcgis.com/datasets/1612d351695b467eba75fdf82c10884f/explore?filters=eyJTVEFURV9BQkJSIjpbIkNPIiwiVlQiLCJOQyIsIk9SIl19&amp;location=48.814319%2C163.610769%2C2.35">ArcGIS Hub</a> (Shapefile download with filters set to the 4 states in question)</li>
</ul></li>
<li>eBird Observation Data
<ul>
<li><a href="https://ebird.org/data/download">eBird Data Access</a></li>
</ul></li>
<li>Raster Data
<ul>
<li><a href="https://www.sciencebase.gov/catalog/item/5540e111e4b0a658d79395d9">DEM | Source Page</a>
<ul>
<li>Download by regions (Great Plains, Northeast, Northwest, Southeast, Southwest, and Upper Midwest)</li>
</ul></li>
<li><a href="https://www.mrlc.gov/data">Urban Imperviousness | Source Page</a>
<ul>
<li><em>NLCD 2019 Percent Developed Imperviousness (CONUS), NLCD 2019 Developed Imperviousness Descriptor (CONUS)</em></li>
</ul></li>
<li><a href="https://www.mrlc.gov/data">Land Cover</a>
<ul>
<li><em>NLCD 2019 Land Cover (CONUS)</em></li>
</ul></li>
<li><a href="https://www.mrlc.gov/data">Canopy</a>
<ul>
<li><em>NLCD 2016 USFS Tree Canopy Cover (CONUS)</em></li>
</ul></li>
<li><a href="https://www.nacse.org/prism/">Weather (min/max temperature, avg precipitation)</a>
<ul>
<li>Download weather raster data for “ppt”, “tmax”, “tmin”, 2017-2019 at a 4km resolution and 30-year monthly normals at an 800m resolution</li>
<li>URL to download 4km data is: <em>https://services.nacse.org/prism/data/public/4km/</em><variable>/<year></year></variable></li>
<li>URL to download 800m data is <em>https://services.nacse.org/prism/data/public/normals/800m/</em><variable>/<month></month></variable></li>
</ul></li>
<li><a href="https://apps.nationalmap.gov/downloader/#/">Hydrography (Water Bodies &amp; Coast) | Source Page</a>
<ul>
<li><a href="https://prd-tnm.s3.amazonaws.com/StagedProducts/Small-scale/data/Hydrography/hydrusm010g.gdb_nt00897.tar.gz">Download</a></li>
</ul></li>
<li><a href="https://www.nrcs.usda.gov/resources/data-and-reports/gridded-national-soil-survey-geographic-database-gnatsgo">Soil | Source Page</a>
<ul>
<li><a href="https://nrcs.app.box.com/v/soils/folder/191790828371">Download</a></li>
</ul></li>
<li>Vegetation Index
<ul>
<li><a href="https://earthexplorer.usgs.gov/">USGS Earth Explorer</a> (eVIIRS NDVI, 02/23/21-03/08/21 1km; 05/04/21-05/17/21 1km; 09/07/21-09/20/21 1km; 11/30/21-12/13/21 1km)</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="boundary-data" class="level2">
<h2 class="anchored" data-anchor-id="boundary-data">Boundary Data</h2>
<p>For simplicity, only <a href="https://hub.arcgis.com/datasets/1612d351695b467eba75fdf82c10884f/explore?filters=eyJTVEFURV9BQkJSIjpbIkNPIiwiVlQiLCJOQyIsIk9SIl19&amp;location=48.814319%2C163.610769%2C2.35">data for the four states that are being used as observation areas</a> needs to be downloaded (as a .shp file). By default, the zipped files should be saved in <em>US_State_Boundaries.zip</em>. Extract the files into a folder of the same name within the data directory, and use the following Python code to split the states into separate files:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># import libraries</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the shapefile into a GeoDataFrame</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>gdf <span class="op">=</span> gpd.read_file(<span class="st">"../data/US_State_Boundaries/US_State_Boundaries.shp"</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>gdf <span class="op">=</span> gdf.to_crs(<span class="st">"EPSG:5070"</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>state_abbreviations <span class="op">=</span> [<span class="st">"CO"</span>, <span class="st">"NC"</span>, <span class="st">"OR"</span>, <span class="st">"VT"</span>]</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>output_dir <span class="op">=</span> <span class="st">"../data/US_State_Boundaries"</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_dir):</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    os.makedirs(output_dir)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> sa <span class="kw">in</span> state_abbreviations:</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>        state_gdf <span class="op">=</span> gdf[gdf[<span class="st">"STATE_ABBR"</span>] <span class="op">==</span> sa]</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>        output_path <span class="op">=</span> os.path.join(output_dir, <span class="ss">f"</span><span class="sc">{</span>sa<span class="sc">}</span><span class="ss">_State_Boundaries.shp"</span>)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>        state_gdf.to_file(output_path)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'Failed to save shapefile for state </span><span class="sc">{</span>sa<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="ebird-data" class="level2">
<h2 class="anchored" data-anchor-id="ebird-data">eBird Data</h2>
<p>There are four regions explored in this analysis from 2016 through 2019 (corresponding to the 4 boundary datasets):</p>
<ul>
<li>Colorado, 2016-2019</li>
<li>North Carolina, 2016-2019</li>
<li>Oregon, 2016-2019</li>
<li>Vermont, 2016-2019</li>
</ul>
<p>Species included are:</p>
<ul>
<li>Belted Kingfisher</li>
<li>Cedar Waxwing</li>
<li>Downy Woodpecker</li>
<li>Ruddy Duck</li>
<li>Sanderling</li>
<li>Sandhill Crane</li>
<li>Sharp-shinned Hawk</li>
<li>Wild Turkey</li>
</ul>
</section>
<section id="observation-data-pre-processing" class="level2">
<h2 class="anchored" data-anchor-id="observation-data-pre-processing">Observation Data Pre-Processing</h2>
<ol type="1">
<li>Download each of the regions from the <a href="https://ebird.org/data/download">eBird Download Page</a>, filtered by date range (you will need to request access annually). They will initially be downloaded as compressed folders, so the contents will need to be extracted. There is also an eBird API, but the use of the API is beyond the scope of this document.</li>
<li>Using the R <a href="https://cornelllabofornithology.github.io/auk/"><code>auk</code> package</a>, the contents can be filtered and saved within the project data directory:</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Import libraries</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(auk)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="fu">auk_set_ebd_path</span>(<span class="st">"../data"</span>, <span class="at">overwrite =</span> T)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify where your eBird datasets were downloaded to</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>ebird.download.dir <span class="ot">&lt;-</span> <span class="st">"../data/ebird_downloads/"</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Define species</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>species <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Sandhill Crane"</span>, <span class="st">"Sharp-shinned Hawk"</span>,</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>             <span class="st">"Wild Turkey"</span>, <span class="st">"Downy Woodpecker"</span>,</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>             <span class="st">"Sanderling"</span>, <span class="st">"Cedar Waxwing"</span>, </span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>             <span class="st">"Belted Kingfisher"</span>, <span class="st">"Ruddy Duck"</span>)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Parse eBird downloads</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (dir <span class="cf">in</span> <span class="fu">list.dirs</span>(ebird.download.dir)[<span class="sc">-</span><span class="dv">1</span>]) {</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># List .txt files that start with "ebd_"</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>  in.file <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> dir, <span class="at">pattern =</span> <span class="st">"^ebd_.*</span><span class="sc">\\</span><span class="st">.txt$"</span>, <span class="at">full.names =</span> T)[[<span class="dv">1</span>]]</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use regular expression to extract state abbreviation</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>  state.abbreviation <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">".*_US-([A-Z]{2})_.*"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, in.file)</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>  out.file <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"../data/"</span>, state.abbreviation, <span class="st">".txt"</span>)</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Read in the filtered data using the `auk` library, saving to `out.file`</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">auk_ebd</span>(in.file) <span class="sc">%&gt;%</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">auk_species</span>(<span class="at">species =</span> species) <span class="sc">%&gt;%</span> </span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">auk_filter</span>(<span class="at">file =</span> out.file, <span class="at">overwrite=</span>T, <span class="at">execute=</span>T)</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Show example (NC data)</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>readr<span class="sc">::</span><span class="fu">read_delim</span>(<span class="st">"../data/NC.txt"</span>, <span class="at">delim =</span> <span class="st">"</span><span class="sc">\t</span><span class="st">"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(<span class="st">`</span><span class="at">COMMON NAME</span><span class="st">`</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">count =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<caption>(NC) observation counts by species </caption>
<thead>
<tr class="header">
<th style="text-align: left;">COMMON NAME</th>
<th style="text-align: right;">count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Belted Kingfisher</td>
<td style="text-align: right;">39564</td>
</tr>
<tr class="even">
<td style="text-align: left;">Cedar Waxwing</td>
<td style="text-align: right;">23921</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Downy Woodpecker</td>
<td style="text-align: right;">105634</td>
</tr>
<tr class="even">
<td style="text-align: left;">Ruddy Duck</td>
<td style="text-align: right;">13698</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Sanderling</td>
<td style="text-align: right;">11470</td>
</tr>
<tr class="even">
<td style="text-align: left;">Sandhill Crane</td>
<td style="text-align: right;">411</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Sharp-shinned Hawk</td>
<td style="text-align: right;">5454</td>
</tr>
<tr class="even">
<td style="text-align: left;">Wild Turkey</td>
<td style="text-align: right;">10959</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Import leaflet</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(leaflet)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Read in sample data</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>nc.shc <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_delim</span>(<span class="st">"../data/NC.txt"</span>, <span class="at">delim =</span> <span class="st">"</span><span class="sc">\t</span><span class="st">"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(<span class="st">`</span><span class="at">COMMON NAME</span><span class="st">`</span> <span class="sc">==</span> <span class="st">"Sandhill Crane"</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="fu">leaflet</span>(nc.shc) <span class="sc">%&gt;%</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addTiles</span>() <span class="sc">%&gt;%</span>  <span class="co"># This adds the OpenStreetMap tiles</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addMarkers</span>(<span class="sc">~</span>LONGITUDE, <span class="sc">~</span>LATITUDE) <span class="sc">%&gt;%</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setView</span>(<span class="at">lng =</span> <span class="fu">mean</span>(nc.shc<span class="sc">$</span>LONGITUDE), <span class="at">lat =</span> <span class="fu">mean</span>(nc.shc<span class="sc">$</span>LATITUDE), <span class="at">zoom =</span> <span class="dv">7</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addProviderTiles</span>(providers<span class="sc">$</span>Stamen.Toner)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="leaflet html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-34f80f53bbcb4003e0f2" style="width:100%;height:464px;"></div>
<script type="application/json" data-for="htmlwidget-34f80f53bbcb4003e0f2">{"x":{"options":{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}}},"calls":[{"method":"addTiles","args":["https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",null,null,{"minZoom":0,"maxZoom":18,"tileSize":256,"subdomains":"abc","errorTileUrl":"","tms":false,"noWrap":false,"zoomOffset":0,"zoomReverse":false,"opacity":1,"zIndex":1,"detectRetina":false,"attribution":"&copy; <a href=\"https://openstreetmap.org\">OpenStreetMap<\/a> contributors, <a href=\"https://creativecommons.org/licenses/by-sa/2.0/\">CC-BY-SA<\/a>"}]},{"method":"addMarkers","args":[[34.738912,34.7378391,36.1875315,36.1875315,36.1875315,36.1875315,36.1875315,36.1875315,36.1875315,36.1875315,36.1875315,36.1875315,36.1875315,36.1875315,36.1447541,36.1447541,34.7157549,34.739753,34.73783,34.7456387,34.71826,34.739753,34.738682,34.741394,34.7456387,34.7398043,34.7396376,34.738141,34.741394,34.741394,34.739753,34.7398043,34.741394,34.7157549,34.71826,34.73783,35.818417,34.819536,36.1871089,36.1871089,36.1871089,36.1871089,36.1871089,36.199733,36.177601,36.177601,36.1778396,36.176596,35.6840715,34.735856,36.1875315,36.1764054,35.954864,36.1527028,36.1527028,35.2364534,35.8842512,35.8861165,35.8861165,35.560436,35.523024,34.2805158,35.601006,35.8512134,35.864075,35.8512134,35.8512134,35.8512134,35.8512134,35.82994,35.8618686,34.7397302,34.7397302,34.739862,34.7397302,34.73963,34.747839,35.447189,35.6840715,35.2580992,35.2580992,35.8193499,35.7066562,34.712734,34.7393941,34.7397302,34.73783,34.7397302,34.73999,34.7393941,34.7397302,34.73963,34.713411,34.73963,35.3977086,35.3977086,36.444867,35.7066562,35.7066562,35.7066562,34.7393987,34.7393987,34.7397302,34.7488944,34.739326,34.741433,34.7393987,34.7393987,34.741059,34.7397302,34.745505,34.747839,34.7393987,34.7393987,34.7393987,34.7393283,36.232581,36.231555,36.233542,35.3710075,35.6932386,36.256274,36.255392,36.2560444,36.255392,36.256249,34.7390287,36.2004344,35.6766872,35.6766872,35.6766872,35.3217702,35.3710075,35.8030083,36.0581719,36.0582716,36.058102,35.3977086,35.3776918,35.3776918,35.3977086,36.4352477,35.8102614,35.6688151,35.7066562,35.7066562,35.7066562,34.741962,34.7397302,34.741962,34.717871,34.740308,35.6688151,36.4392466,35.7066562,35.7066562,35.710392,35.7066562,35.7066562,35.7066562,35.7066562,35.710392,34.7384202,34.739417,34.7396715,34.731966,34.7397302,34.7393941,34.7397302,35.7066562,35.7066562,34.738963,34.7380507,34.738963,34.7369147,34.739,34.738963,34.738963,34.738963,34.720111,34.738963,34.738963,34.740196,34.738963,34.738963,34.738963,34.7390149,34.743312,35.013958,35.068554,35.5278203,35.525011,35.5278203,35.526134,35.5278203,35.5250665,35.5278203,35.5278203,35.5229592,35.5278203,35.5278203,35.5278203,35.5236607,35.672127,35.6688151,35.6688151,35.672127,35.7066562,35.7066562,35.7066562,35.7066562,35.7066562,35.7066562,35.7066562,34.741694,34.742338,34.7397302,34.741593,34.741694,34.741694,34.741694,34.738963,34.7423442,34.741694,34.7418946,34.14937,34.6383552,35.693971,35.693971,35.0857557,36.1896609,35.5400314,34.736377,34.739,35.0379,34.743312,34.738963,34.7403267,34.739,34.739896,34.739768,34.7400749,34.7404,34.7403267,35.99434,35.4758884,35.4795086,35.7066562,35.7066562,34.7393941,34.7393657,34.737565,34.742338,34.736377,34.740705,35.3977086,35.3776918,35.3977086,35.3873001,35.3977086,35.3776918,35.3977086,35.3977086,35.3776918,35.3977086,35.3784444,35.3776918,35.3776918,35.3977086,35.3977086,35.3977086,35.4780058,35.47895,35.478952,35.6688151,35.47895,35.7066562,35.7066562,35.7066562,35.7066562,35.5646095,34.7396715,34.738963,34.740549,34.738287,34.739,34.738963,34.738153,34.738963,34.739,34.738963,34.7366,35.399755,35.4067719,35.250066,35.2580992,35.250066,35.7066562,35.7066562,35.7066562,35.7066562,35.7066562,35.7066562,35.7066562,35.7088429,34.7129,34.7413746,34.741593,34.741593,34.7129,34.7413746,34.7129,34.734929,34.7129,34.740505,34.742717,34.736377,34.734929,34.7404,34.743576,34.734929,34.734929,34.736377,34.7369147,35.633465,35.633465,35.633465,35.633465,35.688909,35.633465,35.633465,35.633465,35.633465,35.633465,35.633465,35.3175964,35.218505,35.218505,35.218505,35.218505,35.7491245,35.7312852,34.739,34.7404,36.2566562,36.2566562,35.7066562,34.7612351,34.7445746,34.755272,34.7445746,34.7445746,34.7612351,34.7376052,34.7376052,34.736377,34.742408,34.739054,36.060465,36.104907,36.105866,36.105483,36.1038052,36.105483,34.7390287,35.7066562,35.7066562,35.7066562,35.7066562,35.7096216,35.7066562,35.7125799,35.7146708,35.7066562,35.7066562,35.711745,35.7066562,35.71098,35.7066562,35.7066562,35.7066562,35.7066562,35.7126743,35.7066562,35.7066562,35.7066562,35.7066562,35.7066562,35.7438124,35.7066562,35.7066562,35.7066562,35.7146708,35.7066562,35.7125799,35.7066562,35.7438124,35.7066562,35.7066562,35.7066562,35.7066562,35.7066562,35.7066562,35.7066562,35.7101322,35.7066562,35.7066562,35.7066562,35.7066562,35.7066562,35.7066562],[-76.651905,-76.6501522,-80.2821636,-80.2821636,-80.2821636,-80.2821636,-80.2821636,-80.2821636,-80.2821636,-80.2821636,-80.2821636,-80.2821636,-80.2821636,-80.2821636,-77.4143887,-77.4143887,-76.6633084,-76.652902,-76.647828,-76.6593563,-76.66385,-76.652902,-76.648229,-76.65177,-76.6593563,-76.6529051,-76.6444659,-76.648391,-76.65177,-76.65177,-76.652902,-76.6529051,-76.65177,-76.6633084,-76.66385,-76.647828,-81.185905,-78.089989,-80.3492682,-80.3492682,-80.3492682,-80.3492682,-80.3492682,-79.7448421,-77.783787,-77.783787,-77.7840185,-77.7787828,-76.5431213,-76.6507745,-80.2821636,-77.7788687,-77.841273,-81.1509204,-81.1509204,-75.5286992,-75.5886009,-75.582853,-75.582853,-75.464313,-78.28336,-77.7701176,-77.860289,-75.8578491,-75.86201,-75.8578491,-75.8578491,-75.8578491,-75.8578491,-75.55782,-75.9045243,-76.652872,-76.652872,-76.652754,-76.652872,-76.65311,-76.649553,-77.5533056,-76.5431213,-82.6941479,-82.6941479,-76.5170802,-76.5659523,-76.658434,-76.6521847,-76.652872,-76.647828,-76.652872,-76.648894,-76.6521847,-76.652872,-76.65311,-76.657887,-76.65311,-82.5444889,-82.5444889,-80.929779,-76.5659523,-76.5659523,-76.5659523,-76.6479958,-76.6479958,-76.652872,-76.6499376,-76.652161,-76.65196,-76.6479958,-76.6479958,-76.651048,-76.652872,-76.64502,-76.649553,-76.6479958,-76.6479958,-76.6479958,-76.6522568,-79.753409,-79.754191,-79.753588,-82.5312603,-76.5421343,-79.743452,-79.74414,-79.7434156,-79.74414,-79.743725,-79.4748402,-81.6423635,-81.0945317,-81.0945317,-81.0945317,-82.4483866,-82.5312603,-82.9587485,-79.4374287,-79.4390434,-79.437995,-82.5444889,-82.5450236,-82.5450236,-82.5444889,-80.9072578,-78.7452686,-76.583848,-76.5659523,-76.5659523,-76.5659523,-76.656706,-76.652872,-76.656706,-76.661491,-76.653994,-76.583848,-78.8778565,-76.5659523,-76.5659523,-76.578946,-76.5659523,-76.5659523,-76.5659523,-76.5659523,-76.578946,-76.6462371,-76.652145,-76.6528009,-76.650475,-76.652872,-76.6521847,-76.652872,-76.5659523,-76.5659523,-76.643437,-76.6455173,-76.643437,-76.6447995,-76.6434,-76.643437,-76.643437,-76.643437,-76.653548,-76.643437,-76.643437,-76.6495114,-76.643437,-76.643437,-76.643437,-76.6434252,-76.639899,-83.841546,-77.0541418,-82.9753536,-82.974042,-82.9753536,-82.930621,-82.9753536,-82.9687071,-82.9753536,-82.9753536,-82.9657745,-82.9753536,-82.9753536,-82.9753536,-82.9691952,-76.594143,-76.583848,-76.583848,-76.594143,-76.5659523,-76.5659523,-76.5659523,-76.5659523,-76.5659523,-76.5659523,-76.5659523,-76.650387,-76.652027,-76.652872,-76.651696,-76.650387,-76.650387,-76.650387,-76.643437,-76.6506779,-76.650387,-76.6516972,-78.09362,-77.4179372,-75.485696,-75.485696,-77.0454897,-76.3875422,-82.5507438,-76.6452,-76.6434,-84.188088,-76.639899,-76.643437,-76.6448134,-76.6434,-76.652841,-76.642622,-76.6427291,-76.6473,-76.6448134,-79.93536,-76.3253049,-80.8277893,-76.5659523,-76.5659523,-76.6521847,-76.6512795,-76.644329,-76.652027,-76.6452,-76.642313,-82.5444889,-82.5450236,-82.5444889,-82.546607,-82.5444889,-82.5450236,-82.5444889,-82.5444889,-82.5450236,-82.5444889,-82.545558,-82.5450236,-82.5450236,-82.5444889,-82.5444889,-82.5444889,-76.4384079,-76.43728,-76.437285,-76.583848,-76.43728,-76.5659523,-76.5659523,-76.5659523,-76.5659523,-82.6238863,-76.6528009,-76.643437,-76.642431,-76.64803,-76.6434,-76.643437,-76.643913,-76.643437,-76.6434,-76.643437,-76.6406,-82.5797653,-82.6435397,-82.705367,-82.6941479,-82.705367,-76.5659523,-76.5659523,-76.5659523,-76.5659523,-76.5659523,-76.5659523,-76.5659523,-76.5766865,-76.6583,-76.6419468,-76.651696,-76.651696,-76.6583,-76.6419468,-76.6583,-76.646486,-76.6583,-76.650185,-76.640737,-76.6452,-76.646486,-76.6473,-76.646424,-76.646486,-76.646486,-76.6452,-76.6447995,-82.55752,-82.55752,-82.55752,-82.55752,-82.5690244,-82.55752,-82.55752,-82.55752,-82.55752,-82.55752,-82.55752,-82.446036,-82.729017,-82.729017,-82.729017,-82.729017,-78.8808918,-81.9030398,-76.6434,-76.6473,-79.7085756,-79.7085756,-76.5659523,-76.629467,-76.6438468,-76.637681,-76.6438468,-76.6438468,-76.629467,-76.6430296,-76.6430296,-76.6452,-76.641118,-76.643341,-77.677219,-77.651605,-77.656467,-77.654625,-77.6554602,-77.654625,-79.4748402,-76.5659523,-76.5659523,-76.5659523,-76.5659523,-76.5779053,-76.5659523,-76.5790651,-76.5880966,-76.5659523,-76.5659523,-76.579364,-76.5659523,-76.577124,-76.5659523,-76.5659523,-76.5659523,-76.5659523,-76.5788766,-76.5659523,-76.5659523,-76.5659523,-76.5659523,-76.5659523,-76.5678711,-76.5659523,-76.5659523,-76.5659523,-76.5880966,-76.5659523,-76.5790651,-76.5659523,-76.5678711,-76.5659523,-76.5659523,-76.5659523,-76.5659523,-76.5659523,-76.5659523,-76.5659523,-76.5806533,-76.5659523,-76.5659523,-76.5659523,-76.5659523,-76.5659523,-76.5659523],null,null,null,{"interactive":true,"draggable":false,"keyboard":true,"title":"","alt":"","zIndexOffset":0,"opacity":1,"riseOnHover":false,"riseOffset":250},null,null,null,null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"addProviderTiles","args":["Stamen.Toner",null,null,{"errorTileUrl":"","noWrap":false,"detectRetina":false}]}],"limits":{"lat":[34.14937,36.444867],"lng":[-84.188088,-75.464313]},"setView":[[35.3367781231144,-78.0437070107056],7,[]]},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Some basic pre-processing</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>preprocess_obs <span class="ot">&lt;-</span> <span class="cf">function</span>(data_path) {</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_delim</span>(data_path, <span class="at">delim =</span> <span class="st">"</span><span class="sc">\t</span><span class="st">"</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(data) <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">"_"</span>, <span class="fu">tolower</span>(<span class="fu">names</span>(data)))</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(approved <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(common_name, observation_count, latitude, longitude) <span class="sc">%&gt;%</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(common_name, latitude, longitude) <span class="sc">%&gt;%</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">observation_count =</span> <span class="fu">sum</span>(<span class="fu">as.numeric</span>(observation_count), <span class="at">na.rm=</span>T)) <span class="sc">%&gt;%</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.data.table</span>()</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(data)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>states <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"CO"</span>, <span class="st">"NC"</span>, <span class="st">"OR"</span>, <span class="st">"VT"</span>)</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>obs <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map</span>(states, <span class="cf">function</span>(.x) {</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">preprocess_obs</span>(<span class="fu">paste0</span>(<span class="st">"../data/"</span>, .x, <span class="st">".txt"</span>))</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fwrite</span>(out, <span class="fu">paste0</span>(<span class="st">"../data/observations_"</span>, .x, <span class="st">".csv"</span>))</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>  out</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(obs) <span class="ot">&lt;-</span> states</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(obs<span class="sc">$</span>NC) <span class="sc">%&gt;%</span> <span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<caption>Sample of (NC) preprocessed observation data </caption>
<thead>
<tr class="header">
<th style="text-align: left;">common_name</th>
<th style="text-align: right;">latitude</th>
<th style="text-align: right;">longitude</th>
<th style="text-align: right;">observation_count</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Belted Kingfisher</td>
<td style="text-align: right;">33.84197</td>
<td style="text-align: right;">-77.96105</td>
<td style="text-align: right;">4</td>
</tr>
<tr class="even">
<td style="text-align: left;">Belted Kingfisher</td>
<td style="text-align: right;">33.85371</td>
<td style="text-align: right;">-77.96410</td>
<td style="text-align: right;">2</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Belted Kingfisher</td>
<td style="text-align: right;">33.85881</td>
<td style="text-align: right;">-77.97316</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">Belted Kingfisher</td>
<td style="text-align: right;">33.85940</td>
<td style="text-align: right;">-78.52684</td>
<td style="text-align: right;">16</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Belted Kingfisher</td>
<td style="text-align: right;">33.86084</td>
<td style="text-align: right;">-77.98328</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">Belted Kingfisher</td>
<td style="text-align: right;">33.86149</td>
<td style="text-align: right;">-77.99476</td>
<td style="text-align: right;">58</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="rasters" class="level2">
<h2 class="anchored" data-anchor-id="rasters">Rasters</h2>
<p>Raster data is a type of digital image represented by a grid of pixels, where each pixel has an associated value that represents information about a particular geographic area. It is one of the two primary ways to represent geospatial data (the other being vector data). In environmental studies and geographic analysis, raster data is extensively used to represent continuous data such as elevation, temperature, or land cover. In this project, raster data serves as the basis for various explanatory variables that influence bird species distributions, including digital elevation, urban imperviousness, land cover, canopy, weather, hydrography, soil, and vegetation index. Each of these variables represents environmental conditions that can affect bird habitat and distribution.</p>
</section>
<section id="raster-pre-processing" class="level2">
<h2 class="anchored" data-anchor-id="raster-pre-processing">Raster Pre-Processing</h2>
<p>Before using raster data for analysis, it is crucial to preprocess them to ensure compatibility, accuracy, and relevancy. Raster pre-processing includes a series of steps that prepare and standardize the raster datasets for subsequent analyses. Along with some general pre-processing steps (and corresponding code), the following sections outline specific pre-processing steps tailored for each type of explanatory variable being used in the analysis.</p>
<section id="general-raster-pre-processing-steps" class="level3">
<h3 class="anchored" data-anchor-id="general-raster-pre-processing-steps">General Raster Pre-Processing Steps</h3>
<ol type="1">
<li>Load the environmental raster datasets &amp; State Boundary data</li>
<li>Reproject to CRS EPSG:5070</li>
<li>Resample each to 2500 x 2500 meters</li>
<li>Mask each raster using State Boundary (ensure oceans and great lakes are set to <code>nodata</code>)</li>
<li>Output updated raster data</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Import libraries</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> arcpy</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> general_raster_preprocessing(</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    raster_name,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    out_raster_name,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    data_path<span class="op">=</span><span class="st">"../data"</span>,</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    state_boundary_path<span class="op">=</span><span class="st">"../data/US_State_Boundaries"</span>,</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    states<span class="op">=</span>[<span class="st">"NC"</span>, <span class="st">"CO"</span>, <span class="st">"OR"</span>, <span class="st">"VT"</span>],</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    state_file_suffix<span class="op">=</span><span class="st">"_State_Boundaries.shp"</span>,</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    out_path<span class="op">=</span><span class="st">"../gis630/data"</span>,</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    crs<span class="op">=</span><span class="dv">5070</span>,</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    wildcard<span class="op">=</span><span class="st">"*"</span>,</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    raster_type<span class="op">=</span><span class="st">"All"</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Example usage:</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># general_raster_preprocessing(</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   raster_name="canopy/nlcd_2016_treecanopy_2019_08_31", </span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   out_raster_name="canopy",</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   out_path="../data/canopy"</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># )</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set the workspace environment, which is the folder where the raster files are located</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>    arcpy.env.workspace <span class="op">=</span> os.path.join(data_path, raster_name)</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Enable overwriting outputs</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    arcpy.env.overwriteOutput <span class="op">=</span> <span class="va">True</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># List all the raster files in the workspace directory</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>    rasters <span class="op">=</span> arcpy.ListRasters(wildcard, raster_type)</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Rasters: "</span>, rasters)</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Loop through each raster file in the list</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> raster <span class="kw">in</span> rasters:</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Reproject the raster to a projected coordinate system with units in meters</span></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>        out_coordinate_system <span class="op">=</span> arcpy.SpatialReference(crs)</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Reprojecting raster to CRS </span><span class="sc">{</span>crs<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>        reprojected_raster <span class="op">=</span> arcpy.ProjectRaster_management(raster, <span class="va">None</span>, out_coordinate_system)</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Resample the reprojected raster to 2500 x 2500 meters resolution using </span></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>        <span class="co"># the nearest neighbor algorithm</span></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Resampling </span><span class="sc">{</span>raster<span class="sc">}</span><span class="ss"> to 2500x2500 meters..."</span>)</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>        resampled_raster <span class="op">=</span> arcpy.Resample_management(reprojected_raster, <span class="va">None</span>, <span class="st">"2500 2500"</span>, <span class="st">"NEAREST"</span>)</span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Loop through each state in the states list</span></span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> state <span class="kw">in</span> states:</span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Construct the file path to the state boundary shapefile</span></span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>            state_path <span class="op">=</span> os.path.join(state_boundary_path, state <span class="op">+</span> state_file_suffix)</span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Extract the area of the resampled raster that intersects with the state boundary</span></span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Extracting </span><span class="sc">{</span>state<span class="sc">}</span><span class="ss"> data using state mask..."</span>)</span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>            out_state_raster <span class="op">=</span> arcpy.sa.ExtractByMask(reprojected_raster, state_path)</span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Save the extracted raster to a new file with state abbreviation appended to name</span></span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>            out_state_raster.save(os.path.join(out_path, out_raster_name <span class="op">+</span> <span class="st">"_"</span> <span class="op">+</span> state <span class="op">+</span> <span class="st">".tif"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><em>Ensure that extents match for each raster.</em></p>
</section>
<section id="digital-elevation-model-dem" class="level3">
<h3 class="anchored" data-anchor-id="digital-elevation-model-dem">Digital Elevation Model (DEM)</h3>
<p>DEM Pre-Processing Steps:</p>
<ol type="1">
<li>Using <code>arcpy.management.MosaicToNewRaster</code>, join all DEM raster parts into single raster</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Import libraries</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> arcpy</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> list_rasters_recursive(directory, raster_list<span class="op">=</span>[]):</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="st">"mosaic"</span> <span class="kw">in</span> directory: </span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>        arcpy.env.workspace <span class="op">=</span> directory</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>        rasters <span class="op">=</span> arcpy.ListRasters(<span class="st">"*"</span>, <span class="st">"ADF"</span>)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> rasters:</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>            raster_list.extend([directory])</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># recurse into subdirectories</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> subdir <span class="kw">in</span> [d <span class="cf">for</span> d <span class="kw">in</span> os.listdir(directory) <span class="cf">if</span> os.path.isdir(os.path.join(directory, d))]:</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>        list_rasters_recursive(os.path.join(directory, subdir), raster_list)</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> raster_list</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> combine_dem_parts(</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    dem_dir<span class="op">=</span><span class="st">"../data/dem/raw_dem"</span>, </span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    output_dir<span class="op">=</span><span class="st">"../data/dem"</span>, </span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    output_raster_name<span class="op">=</span><span class="st">"mosaic_dem"</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>  ):</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>  rasters <span class="op">=</span> <span class="bu">list</span>(<span class="bu">set</span>(list_rasters_recursive(dem_dir)))</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert the list of rasters to a semicolon-delimited string</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>  rasters_string <span class="op">=</span> <span class="st">';'</span>.join(rasters)</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use Mosaic to New Raster tool to join all the rasters together</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>  arcpy.management.MosaicToNewRaster(rasters_string, </span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>                                     output_dir,</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>                                     output_raster_name <span class="op">+</span> <span class="st">".tif"</span>, </span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>                                     <span class="va">None</span>, </span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">"32_BIT_FLOAT"</span>, </span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>                                     <span class="va">None</span>, </span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>                                     <span class="dv">1</span>, </span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">"LAST"</span>, </span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>                                     <span class="st">"FIRST"</span>)</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(<span class="st">"Mosaic completed successfully!"</span>)</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine rasters in "raw_dem" folder (great_plains, northeast, northwest, etc.)</span></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>combine_dem_parts(dem_dir<span class="op">=</span><span class="st">"../data/dem/raw_dem"</span>, output_dir<span class="op">=</span><span class="st">"../data/dem"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="2" type="1">
<li>Follows <a href="#general-raster-pre-processing-steps">general raster pre-processing steps</a>, using the combined raster from step 1</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Using the combined raster, apply "general raster preprocessing" (resample, reproject, mask)</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>general_raster_preprocessing(</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    raster_name<span class="op">=</span><span class="st">"dem"</span>, </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    out_raster_name<span class="op">=</span><span class="st">"dem"</span>,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    out_path<span class="op">=</span><span class="st">"dem"</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="urban-imperviousness" class="level3">
<h3 class="anchored" data-anchor-id="urban-imperviousness">Urban Imperviousness</h3>
<p><em>(Follows <a href="#general-raster-pre-processing-steps">general raster pre-processing steps</a>)</em></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Using the combined raster, apply "general raster preprocessing" (resample, reproject, mask)</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>general_raster_preprocessing(</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    raster_name<span class="op">=</span><span class="st">"urban_imperviousness"</span>, </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    out_raster_name<span class="op">=</span><span class="st">"urban_imperviousness"</span>,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    out_path<span class="op">=</span><span class="st">"../data/urban_imperviousness"</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="land-cover" class="level3">
<h3 class="anchored" data-anchor-id="land-cover">Land Cover</h3>
<ol type="1">
<li>Follow <a href="#general-raster-pre-processing-steps">general raster pre-processing steps</a></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Using the combined raster, apply "general raster preprocessing" (resample, reproject, mask)</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>general_raster_preprocessing(</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    raster_name<span class="op">=</span><span class="st">"land_cover/nlcd_2019_land_cover_l48_20210604"</span>, </span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    out_raster_name<span class="op">=</span><span class="st">"land_cover"</span>,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    out_path<span class="op">=</span><span class="st">"../data/land_cover"</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="2" type="1">
<li>Set values of 128 to NA</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Import libraries</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> arcpy</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shutil</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> arcpy.sa <span class="im">import</span> Con</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> arcpy.sa <span class="im">import</span> Raster</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fix_lc_na(data_path, na_val, states<span class="op">=</span>[<span class="st">"CO"</span>, <span class="st">"NC"</span>, <span class="st">"OR"</span>, <span class="st">"VT"</span>]):</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> state <span class="kw">in</span> states:</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set path of the input raster</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    input_raster_path <span class="op">=</span> os.path.join(data_path, <span class="ss">f"land_cover_</span><span class="sc">{</span>state<span class="sc">}</span><span class="ss">.tif"</span>)</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a temporary output path</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    temp_output_path <span class="op">=</span> os.path.join(data_path, <span class="ss">f"temp_land_cover_</span><span class="sc">{</span>state<span class="sc">}</span><span class="ss">.tif"</span>)</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Read the input raster</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    input_raster <span class="op">=</span> Raster(input_raster_path)</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use the Con tool to set values of the defined na value to NoData</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    output_raster <span class="op">=</span> Con(input_raster <span class="op">!=</span> na_val, input_raster)</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save the output raster to the temporary file path</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    output_raster.save(temp_output_path)</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Delete raster variables to release locks on the files</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">del</span> input_raster</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">del</span> output_raster</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Allow arcpy to perform garbage collection</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>    arcpy.ClearWorkspaceCache_management()</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>    temp_files <span class="op">=</span> [os.path.join(data_path, f) <span class="cf">for</span> f <span class="kw">in</span> os.listdir(data_path) <span class="cf">if</span> f.startswith(<span class="st">"temp_"</span>)]</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> temp_files:</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Move the temporary file to the original file path</span></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>      shutil.move(<span class="bu">file</span>, <span class="bu">file</span>.replace(<span class="st">"temp_"</span>, <span class="st">""</span>))</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>fix_lc_na(data_path<span class="op">=</span><span class="st">"../data/land_cover"</span>, na_val<span class="op">=</span><span class="dv">128</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="canopy" class="level3">
<h3 class="anchored" data-anchor-id="canopy">Canopy</h3>
<p><em>(Follows <a href="#general-raster-pre-processing-steps">general raster pre-processing steps</a>)</em></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Using the combined raster, apply "general raster preprocessing" (resample, reproject, mask)</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>general_raster_preprocessing(</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    raster_name<span class="op">=</span><span class="st">"canopy/nlcd_2016_treecanopy_2019_08_31"</span>, </span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    out_raster_name<span class="op">=</span><span class="st">"canopy"</span>,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    out_path<span class="op">=</span><span class="st">"../data/canopy"</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="weather" class="level3">
<h3 class="anchored" data-anchor-id="weather">Weather</h3>
<p>Downloading the weather data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Import libraries</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> urllib.request</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> zipfile</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_weather_data(data_path:<span class="bu">str</span>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Downloads and processes weather raster data for specified variables and years at a 4km resolution </span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="co">    and 30-year monthly normals at an 800m resolution. The function downloads, aggregates, and resamples </span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="co">    the rasters before trimming them to the North Carolina boundary.</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Args</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="co">    - data_path : A file path to the data directory</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Output</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="co">    A list of aggregated raster layer names (should match the last three inputs)</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Checks to confirm valid file paths</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_path):</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">FileNotFoundError</span>(<span class="ss">f"Data path '</span><span class="sc">{</span>data_path<span class="sc">}</span><span class="ss">' not found."</span>)</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">vars</span> <span class="op">=</span> [<span class="st">"ppt"</span>, <span class="st">"tmax"</span>, <span class="st">"tmin"</span>]</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Setup for yearly 4km resolution </span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    yrs <span class="op">=</span> [<span class="dv">2017</span>, <span class="dv">2018</span>, <span class="dv">2019</span>]</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    pairs <span class="op">=</span> <span class="bu">list</span>()</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    pairs <span class="op">=</span> [(v, y) <span class="cf">for</span> v <span class="kw">in</span> <span class="bu">vars</span> <span class="cf">for</span> y <span class="kw">in</span> yrs <span class="cf">if</span> (v, y) <span class="kw">not</span> <span class="kw">in</span> pairs]</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Setup for 30 year normal monthly 800m resolution</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>    mnths <span class="op">=</span> [<span class="st">"</span><span class="sc">{:02d}</span><span class="st">"</span>.<span class="bu">format</span>(m) <span class="cf">for</span> m <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">13</span>)]</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>    norm_pairs <span class="op">=</span> <span class="bu">list</span>()</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>    norm_pairs <span class="op">=</span> [(v, m) <span class="cf">for</span> v <span class="kw">in</span> <span class="bu">vars</span> <span class="cf">for</span> m <span class="kw">in</span> mnths <span class="cf">if</span> (v, m) <span class="kw">not</span> <span class="kw">in</span> norm_pairs]</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">### Get Raster Data ######</span></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Getting explanatory Weather Rasters..."</span>)</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Data documentation https://www.prism.oregonstate.edu/documents/PRISM_downloads_web_service.pdf</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>    out_path <span class="op">=</span> os.path.join(data_path, <span class="st">"weather/"</span>)</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>    os.makedirs(out_path, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4km yearly data (for 2017-2019)</span></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> v, y <span class="kw">in</span> pairs:</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>        dwnld_out <span class="op">=</span> os.path.join(out_path, <span class="ss">f"</span><span class="sc">{</span>v<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>y<span class="sc">}</span><span class="ss">.zip"</span>)</span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>        dwnld_path <span class="op">=</span> os.path.join(out_path, <span class="ss">f"</span><span class="sc">{</span>v<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>y<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> os.path.exists(dwnld_path):</span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>            url <span class="op">=</span> <span class="ss">f"https://services.nacse.org/prism/data/public/4km/</span><span class="sc">{</span>v<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>y<span class="sc">}</span><span class="ss">"</span> </span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Downloading weather data from </span><span class="sc">{</span>url<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>            urllib.request.urlretrieve(url, dwnld_out)</span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Saved </span><span class="sc">{</span>v<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>y<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>dwnld_out<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> zipfile.ZipFile(dwnld_out, <span class="st">"r"</span>) <span class="im">as</span> zfile:</span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>                zfile.extractall(dwnld_path)</span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Extracted </span><span class="sc">{</span>v<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>y<span class="sc">}</span><span class="ss"> from </span><span class="sc">{</span>dwnld_out<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>dwnld_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>            os.remove(dwnld_out)</span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 800m monthly data (30 year normals), used to estimate higher resolution for the 4km data</span></span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> v, m <span class="kw">in</span> norm_pairs:</span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a>        dwnld_out <span class="op">=</span> os.path.join(out_path, <span class="ss">f"</span><span class="sc">{</span>v<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>m<span class="sc">}</span><span class="ss">.zip"</span>)</span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a>        dwnld_path <span class="op">=</span> os.path.join(out_path, <span class="ss">f"</span><span class="sc">{</span>v<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>m<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> os.path.exists(dwnld_path):</span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a>            url <span class="op">=</span> <span class="ss">f"https://services.nacse.org/prism/data/public/normals/800m/</span><span class="sc">{</span>v<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>m<span class="sc">}</span><span class="ss">"</span> </span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Downloading weather data from </span><span class="sc">{</span>url<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a>            urllib.request.urlretrieve(url, dwnld_out)</span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Saved </span><span class="sc">{</span>v<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>m<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>dwnld_out<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> zipfile.ZipFile(dwnld_out, <span class="st">"r"</span>) <span class="im">as</span> zfile:</span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true" tabindex="-1"></a>                zfile.extractall(dwnld_path)</span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Extracted </span><span class="sc">{</span>v<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>m<span class="sc">}</span><span class="ss"> from </span><span class="sc">{</span>dwnld_out<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>dwnld_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-64"><a href="#cb13-64" aria-hidden="true" tabindex="-1"></a>            os.remove(dwnld_out)</span>
<span id="cb13-65"><a href="#cb13-65" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-66"><a href="#cb13-66" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Finished."</span>)</span>
<span id="cb13-67"><a href="#cb13-67" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb13-68"><a href="#cb13-68" aria-hidden="true" tabindex="-1"></a>get_weather_data(<span class="st">"../data"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Weather Pre-Processing Steps:</p>
<ol type="1">
<li>Iteratively load yearly data by variable (using <code>get_rasters_from_dir</code>)</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Import libraries</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> arcpy</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_rasters_from_dir(var:<span class="bu">str</span>, </span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>                         periods:<span class="bu">list</span>, </span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>                         out_path:<span class="bu">str</span>) <span class="op">-&gt;</span> List[arcpy.Raster]:</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Retrieves a list of arcpy.Raster objects from the specified directory based on the input parameters.</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Args</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="co">    var : The variable type (e.g. 'prcp', 'tmin', or 'tmax').</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="co">    periods : A list of periods (years or months) for which rasters are needed.</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="co">    out_path : The path to the directory containing the raster files.</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="co">    Output</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="co">    A list of arcpy.Raster objects corresponding to the specified variable and periods.</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>        arcpy.Raster(</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>            os.path.join(</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>                os.path.join(out_path, <span class="ss">f"</span><span class="sc">{</span>var<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>p<span class="sc">}</span><span class="ss">"</span>), </span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>                [f <span class="cf">for</span> f <span class="kw">in</span> os.listdir(os.path.join(out_path, <span class="ss">f"</span><span class="sc">{</span>var<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>p<span class="sc">}</span><span class="ss">"</span>) ) <span class="op">\</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>                 <span class="cf">if</span> f.endswith(<span class="st">'.bil'</span>) <span class="kw">and</span> var <span class="kw">in</span> f][<span class="dv">0</span>]</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>        ) <span class="cf">for</span> p <span class="kw">in</span> periods] </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="2" type="1">
<li>Aggregate all of the yearly rasters for each variable with the corresponding function (max, min, avg) using <code>arcpy.sa.CellStatistics</code></li>
<li>Save to (intermediate) raster files</li>
<li>Repeat steps 1-3 on monthly data, by variable</li>
<li>Calculate the weights based on the number of years in the datasets (3)</li>
<li>Combine monthly/yearly rasters by variable, applying weights (<code>arcpy.Raster("aggregated_year_raster") * year_weight + arcpy.Raster("aggregated_month_raster") * month_weight</code>)</li>
<li>Apply <a href="#general-raster-pre-processing-steps">general raster pre-Processing steps</a> to each combined raster (final output should be 1 raster per variable)</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>data_path <span class="op">=</span> <span class="st">"../data/weather"</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>wspace <span class="op">=</span> <span class="st">"../data/weather/aggregated"</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(wspace):</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  os.mkdir(wspace)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>max_temp_data <span class="op">=</span> <span class="st">"max_temp.tif"</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>min_temp_data <span class="op">=</span> <span class="st">"min_temp.tif"</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>avg_prcp_data <span class="op">=</span> <span class="st">"avg_prcp.tif"</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>states <span class="op">=</span> [<span class="st">"CO"</span>, <span class="st">"NC"</span>, <span class="st">"OR"</span>, <span class="st">"VT"</span>]</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="bu">vars</span> <span class="op">=</span> [<span class="st">"ppt"</span>, <span class="st">"tmax"</span>, <span class="st">"tmin"</span>]</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup for yearly 4km resolution </span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>yrs <span class="op">=</span> [<span class="dv">2017</span>, <span class="dv">2018</span>, <span class="dv">2019</span>]</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>pairs <span class="op">=</span> <span class="bu">list</span>()</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>pairs <span class="op">=</span> [(v, y) <span class="cf">for</span> v <span class="kw">in</span> <span class="bu">vars</span> <span class="cf">for</span> y <span class="kw">in</span> yrs <span class="cf">if</span> (v, y) <span class="kw">not</span> <span class="kw">in</span> pairs]</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup for 30 year normal monthly 800m resolution</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>mnths <span class="op">=</span> [<span class="st">"</span><span class="sc">{:02d}</span><span class="st">"</span>.<span class="bu">format</span>(m) <span class="cf">for</span> m <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">13</span>)]</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>norm_pairs <span class="op">=</span> <span class="bu">list</span>()</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>norm_pairs <span class="op">=</span> [(v, m) <span class="cf">for</span> v <span class="kw">in</span> <span class="bu">vars</span> <span class="cf">for</span> m <span class="kw">in</span> mnths <span class="cf">if</span> (v, m) <span class="kw">not</span> <span class="kw">in</span> norm_pairs]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">### Process data and add to GDB #########</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> var <span class="kw">in</span> <span class="bu">vars</span>:</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Checking </span><span class="sc">{</span>var<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    out_path <span class="op">=</span> os.path.join(wspace, var)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(out_path):</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>        os.mkdir(out_path)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set workspace</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    arcpy.env.workspace <span class="op">=</span> out_path</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> var <span class="op">==</span> <span class="st">"tmax"</span>:</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>        raster <span class="op">=</span> max_temp_data</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> var <span class="op">==</span> <span class="st">"tmin"</span>:</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>        raster <span class="op">=</span> min_temp_data</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>        raster <span class="op">=</span> avg_prcp_data</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    arcpy.env.overwriteOutput <span class="op">=</span> <span class="va">True</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Average with other years of same var type</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    agg_rasters <span class="op">=</span> <span class="bu">dict</span>()</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Yearly data</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>    rasters <span class="op">=</span> get_rasters_from_dir(var, yrs, data_path)</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>    raster_out <span class="op">=</span> raster</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> var <span class="op">==</span> <span class="st">"tmax"</span>:</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>        agg_func <span class="op">=</span> <span class="st">"MAXIMUM"</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> var <span class="op">==</span> <span class="st">"tmin"</span>:</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>        agg_func <span class="op">=</span> <span class="st">"MINIMUM"</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> var <span class="op">==</span> <span class="st">"ppt"</span>:</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>        agg_func <span class="op">=</span> <span class="st">"MEAN"</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>    agg_rasters.update({var:{<span class="st">"yr"</span>:raster_out}})</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Aggregating </span><span class="sc">{</span>var<span class="sc">}</span><span class="ss"> for all years..."</span>)</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>    outCellStats <span class="op">=</span> arcpy.sa.CellStatistics(rasters, agg_func, <span class="st">"DATA"</span>)</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>    outCellStats.save(raster_out)</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Finished aggregating </span><span class="sc">{</span>var<span class="sc">}</span><span class="ss"> for all years."</span>)</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Monthly 30-year normals</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>    rasters <span class="op">=</span> get_rasters_from_dir(var, mnths, data_path) </span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>    raster_out <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>var<span class="sc">}</span><span class="ss">_30yr_800m.tif"</span></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>    agg_rasters[var].update({<span class="st">"norm"</span>:raster_out})</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Aggregating </span><span class="sc">{</span>var<span class="sc">}</span><span class="ss"> for all 800m 30 year normal months..."</span>)</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>    outCellStats <span class="op">=</span> arcpy.sa.CellStatistics(rasters, agg_func, <span class="st">"DATA"</span>)</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>    outCellStats.save(raster_out)</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Finished aggregating </span><span class="sc">{</span>var<span class="sc">}</span><span class="ss"> for all 30 year normal months."</span>)</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate the weights based on the number of years in the datasets</span></span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>    initial_weight_4km <span class="op">=</span> <span class="fl">3.0</span></span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>    initial_weight_800m <span class="op">=</span> <span class="fl">3.0</span> <span class="op">/</span> <span class="fl">30.0</span></span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>    total_weight <span class="op">=</span> initial_weight_4km <span class="op">+</span> initial_weight_800m</span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>    normalized_weight_4km <span class="op">=</span> initial_weight_4km <span class="op">/</span> total_weight</span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>    normalized_weight_800m <span class="op">=</span> initial_weight_800m <span class="op">/</span> total_weight</span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>    combined_raster <span class="op">=</span> (arcpy.Raster(agg_rasters[var][<span class="st">"yr"</span>]) <span class="op">*</span> normalized_weight_4km) <span class="op">+</span> <span class="op">\</span></span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>      (arcpy.Raster(agg_rasters[var][<span class="st">"norm"</span>]) <span class="op">*</span> normalized_weight_800m)</span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>    combined_raster.save(<span class="st">"aggregated_"</span> <span class="op">+</span> raster)</span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Using the combined raster, apply "general raster preprocessing" (resample, reproject, mask)</span></span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>    general_raster_preprocessing(</span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>        raster_name<span class="op">=</span><span class="ss">f"weather/aggregated/</span><span class="sc">{</span>var<span class="sc">}</span><span class="ss">"</span>, </span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>        out_raster_name<span class="op">=</span>var,</span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>        out_path<span class="op">=</span><span class="st">"../data/weather"</span>,</span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>        wildcard<span class="op">=</span><span class="st">"agg*"</span></span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a>    arcpy.env.overwriteOutput <span class="op">=</span> <span class="va">False</span></span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Finished.)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="hydrography-water-bodies-coasts" class="level3">
<h3 class="anchored" data-anchor-id="hydrography-water-bodies-coasts">Hydrography (Water Bodies &amp; Coasts)</h3>
<p>Hydrography Pre-Processing Steps:</p>
<ol type="1">
<li>Use <code>arcpy.conversion.FeatureClassToShapefile</code> to convert file geodatabase to shapefiles</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Import libraries</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> arcpy</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> convert_hydro_gdb(</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>        data_path:<span class="bu">str</span><span class="op">=</span><span class="st">"../data/hydrography/"</span>,</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>        gdb_name:<span class="bu">str</span><span class="op">=</span><span class="st">"hydrusm010g.gdb_nt00897/hydrusm010g.gdb"</span>,</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>        data_sets:<span class="bu">list</span><span class="op">=</span>[<span class="st">"Coastline"</span>, <span class="st">"Waterbody"</span>],</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>        output_path:<span class="bu">str</span><span class="op">=</span><span class="st">"../data/hydrography/"</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">-&gt;</span> <span class="va">None</span>: </span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    input_str <span class="op">=</span> <span class="st">";"</span>.join([os.path.join(data_path, gdb_name, ds) <span class="cf">for</span> ds <span class="kw">in</span> data_sets])</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> arcpy.conversion.FeatureClassToShapefile(input_str, output_path)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>convert_hydro_gdb()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="2" type="1">
<li>Load waterbody data &amp; State Boundary data as dataframes
<ol type="a">
<li>Remove “Lake Dry” features from waterbody data</li>
<li>Create binary values in waterbody and boundary datasets (waterbody data -&gt; 0, boundary data -&gt; 1)</li>
<li>Reproject CRS of both to EPSG:5070</li>
<li>Perform unary union on boundary data, calculate total bounds</li>
<li>Get all points in US boundary using bounds and a resolution of 2500 meters</li>
<li>Join points with water body data; Set oceans/great lakes to <code>nodata</code> using preset binary values</li>
<li>Set metadata and export waterbody data to raster</li>
<li>Create “zones” based on distance from water bodies using binary dilation (i.e., on a water body is 1, 0 to 2500 meters away is 0.8, etc.)</li>
<li>Output raster</li>
</ol></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Import libraries</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rasterio.transform <span class="im">import</span> from_origin</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rasterio</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shapely.geometry <span class="im">import</span> Point</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.ndimage <span class="im">import</span> binary_dilation</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>data_path <span class="op">=</span> <span class="st">"../data"</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>hyd_data_path <span class="op">=</span> os.path.join(data_path, <span class="st">"hydrography"</span>)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>states <span class="op">=</span> [<span class="st">"CO"</span>, <span class="st">"NC"</span>, <span class="st">"OR"</span>, <span class="st">"VT"</span>]</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>resolution <span class="op">=</span> <span class="dv">2500</span>  <span class="co"># in the same units as your CRS</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> update_array(arr):</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a copy of the array to hold the updated values</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    arr_updated <span class="op">=</span> arr.copy().astype(<span class="bu">float</span>)</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">=</span> arr <span class="op">==</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create the structuring element for dilation</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    selem <span class="op">=</span> np.array([[<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>],</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>                      [<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>],</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>                      [<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>]])</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Perform the dilation operation multiple times</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>    dilated1 <span class="op">=</span> binary_dilation(arr <span class="op">==</span> <span class="dv">1</span>, structure<span class="op">=</span>selem)</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>    dilated2 <span class="op">=</span> binary_dilation(dilated1, structure<span class="op">=</span>selem)</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>    dilated3 <span class="op">=</span> binary_dilation(dilated2, structure<span class="op">=</span>selem)</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>    dilated4 <span class="op">=</span> binary_dilation(dilated3, structure<span class="op">=</span>selem)</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Subtract the result from the original dilation to get the zones</span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>    zone1 <span class="op">=</span> dilated1 <span class="op">&amp;</span> <span class="op">~</span>(arr <span class="op">==</span> <span class="dv">1</span>)</span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>    zone2 <span class="op">=</span> dilated2 <span class="op">&amp;</span> <span class="op">~</span>dilated1</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>    zone3 <span class="op">=</span> dilated3 <span class="op">&amp;</span> <span class="op">~</span>dilated2</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>    zone4 <span class="op">=</span> dilated4 <span class="op">&amp;</span> <span class="op">~</span>dilated3</span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update the values in the array based on the zones</span></span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>    arr_updated[zone1] <span class="op">=</span> <span class="fl">0.8</span></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>    arr_updated[zone2] <span class="op">=</span> <span class="fl">0.6</span></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>    arr_updated[zone3] <span class="op">=</span> <span class="fl">0.4</span></span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>    arr_updated[zone4] <span class="op">=</span> <span class="fl">0.2</span></span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>    arr_updated[mask] <span class="op">=</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> arr_updated</span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the shapefile</span></span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Reading waterbody data..."</span>)</span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>gdf <span class="op">=</span> gpd.read_file(os.path.join(hyd_data_path, <span class="st">'Waterbody.shp'</span>))</span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter out records where Feature == "Dry Lake"</span></span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a>gdf <span class="op">=</span> gdf[gdf[<span class="st">'Feature'</span>] <span class="op">!=</span> <span class="st">'Lake Dry'</span>]</span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Overwrite the original shapefile</span></span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a>gdf.to_file(os.path.join(hyd_data_path, <span class="st">'Waterbody.shp'</span>)</span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a new column in the waterbody and streams dataframes with all values set to 0</span></span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Creating raster values..."</span>)</span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a>water_bodies[<span class="st">'raster_value'</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> state <span class="kw">in</span> states:</span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Reading </span><span class="sc">{</span>state<span class="sc">}</span><span class="ss"> boundary data..."</span>)</span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a>    state_boundary <span class="op">=</span> gpd.read_file(</span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a>        os.path.join(data_path, <span class="ss">f"US_State_Boundaries/</span><span class="sc">{</span>state<span class="sc">}</span><span class="ss">_State_Boundaries.shp"</span>)</span>
<span id="cb18-65"><a href="#cb18-65" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb18-66"><a href="#cb18-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-67"><a href="#cb18-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a new column in the us_boundary dataframe with all values set to 1</span></span>
<span id="cb18-68"><a href="#cb18-68" aria-hidden="true" tabindex="-1"></a>    state_boundary[<span class="st">'raster_value'</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb18-69"><a href="#cb18-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-70"><a href="#cb18-70" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Reproject to a common CRS</span></span>
<span id="cb18-71"><a href="#cb18-71" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Reprojecting..."</span>)</span>
<span id="cb18-72"><a href="#cb18-72" aria-hidden="true" tabindex="-1"></a>    water_bodies <span class="op">=</span> water_bodies.to_crs(<span class="st">'EPSG:5070'</span>)</span>
<span id="cb18-73"><a href="#cb18-73" aria-hidden="true" tabindex="-1"></a>    state_boundary <span class="op">=</span> state_boundary.to_crs(<span class="st">'EPSG:5070'</span>)</span>
<span id="cb18-74"><a href="#cb18-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-75"><a href="#cb18-75" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a single polygon representing the mainland US</span></span>
<span id="cb18-76"><a href="#cb18-76" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Combining US states..."</span>)</span>
<span id="cb18-77"><a href="#cb18-77" aria-hidden="true" tabindex="-1"></a>    state_boundary <span class="op">=</span> state_boundary.unary_union</span>
<span id="cb18-78"><a href="#cb18-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-79"><a href="#cb18-79" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a new GeoDataFrame with the combined polygon and set the raster value to 1</span></span>
<span id="cb18-80"><a href="#cb18-80" aria-hidden="true" tabindex="-1"></a>    state_boundary <span class="op">=</span> gpd.GeoDataFrame([<span class="dv">1</span>], </span>
<span id="cb18-81"><a href="#cb18-81" aria-hidden="true" tabindex="-1"></a>                                      geometry<span class="op">=</span>[state_boundary], </span>
<span id="cb18-82"><a href="#cb18-82" aria-hidden="true" tabindex="-1"></a>                                      columns<span class="op">=</span>[<span class="st">'raster_value'</span>], </span>
<span id="cb18-83"><a href="#cb18-83" aria-hidden="true" tabindex="-1"></a>                                      crs<span class="op">=</span><span class="st">'EPSG:5070'</span>)</span>
<span id="cb18-84"><a href="#cb18-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-85"><a href="#cb18-85" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine the extent of the combined GeoDataFrame</span></span>
<span id="cb18-86"><a href="#cb18-86" aria-hidden="true" tabindex="-1"></a>    xmin, ymin, xmax, ymax <span class="op">=</span> state_boundary.total_bounds</span>
<span id="cb18-87"><a href="#cb18-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-88"><a href="#cb18-88" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a grid of points within this extent</span></span>
<span id="cb18-89"><a href="#cb18-89" aria-hidden="true" tabindex="-1"></a>    ys, xs <span class="op">=</span> np.mgrid[ymin:ymax:resolution, xmin:xmax:resolution]</span>
<span id="cb18-90"><a href="#cb18-90" aria-hidden="true" tabindex="-1"></a>    points <span class="op">=</span> gpd.GeoDataFrame(geometry<span class="op">=</span>[Point(x, y) <span class="cf">for</span> x, y <span class="kw">in</span> <span class="bu">zip</span>(xs.flatten(), ys.flatten())], </span>
<span id="cb18-91"><a href="#cb18-91" aria-hidden="true" tabindex="-1"></a>                              crs<span class="op">=</span><span class="st">"EPSG:5070"</span>)</span>
<span id="cb18-92"><a href="#cb18-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-93"><a href="#cb18-93" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Assign each point a value based on whether it falls within a water polygon or not</span></span>
<span id="cb18-94"><a href="#cb18-94" aria-hidden="true" tabindex="-1"></a>    points[<span class="st">'is_within_bounds'</span>] <span class="op">=</span> gpd.sjoin(points, </span>
<span id="cb18-95"><a href="#cb18-95" aria-hidden="true" tabindex="-1"></a>                                           state_boundary, </span>
<span id="cb18-96"><a href="#cb18-96" aria-hidden="true" tabindex="-1"></a>                                           predicate<span class="op">=</span><span class="st">'within'</span>, </span>
<span id="cb18-97"><a href="#cb18-97" aria-hidden="true" tabindex="-1"></a>                                           how<span class="op">=</span><span class="st">'left'</span>)[<span class="st">'index_right'</span>].notna().astype(<span class="bu">int</span>)</span>
<span id="cb18-98"><a href="#cb18-98" aria-hidden="true" tabindex="-1"></a>    points[<span class="st">'is_water'</span>] <span class="op">=</span> gpd.sjoin(points, </span>
<span id="cb18-99"><a href="#cb18-99" aria-hidden="true" tabindex="-1"></a>                                   water_bodies, </span>
<span id="cb18-100"><a href="#cb18-100" aria-hidden="true" tabindex="-1"></a>                                   predicate<span class="op">=</span><span class="st">'within'</span>, how<span class="op">=</span><span class="st">'left'</span>)[<span class="st">'index_right'</span>].notna().astype(<span class="bu">int</span>)</span>
<span id="cb18-101"><a href="#cb18-101" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Assign a 'nodata' value to points that are not within the US mainland boundary</span></span>
<span id="cb18-102"><a href="#cb18-102" aria-hidden="true" tabindex="-1"></a>    points.loc[points[<span class="st">'is_within_bounds'</span>] <span class="op">==</span> <span class="dv">0</span>, <span class="st">'is_water'</span>] <span class="op">=</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb18-103"><a href="#cb18-103" aria-hidden="true" tabindex="-1"></a>    points.drop(columns<span class="op">=</span><span class="st">'is_within_bounds'</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb18-104"><a href="#cb18-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-105"><a href="#cb18-105" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a raster from these points</span></span>
<span id="cb18-106"><a href="#cb18-106" aria-hidden="true" tabindex="-1"></a>    transform <span class="op">=</span> from_origin(xmin, ymax, resolution, resolution)  <span class="co"># rasterio transform (Affine object)</span></span>
<span id="cb18-107"><a href="#cb18-107" aria-hidden="true" tabindex="-1"></a>    meta <span class="op">=</span> {</span>
<span id="cb18-108"><a href="#cb18-108" aria-hidden="true" tabindex="-1"></a>        <span class="st">'driver'</span>: <span class="st">'GTiff'</span>,</span>
<span id="cb18-109"><a href="#cb18-109" aria-hidden="true" tabindex="-1"></a>        <span class="st">'height'</span>: ys.shape[<span class="dv">0</span>],</span>
<span id="cb18-110"><a href="#cb18-110" aria-hidden="true" tabindex="-1"></a>        <span class="st">'width'</span>: xs.shape[<span class="dv">1</span>],</span>
<span id="cb18-111"><a href="#cb18-111" aria-hidden="true" tabindex="-1"></a>        <span class="st">'count'</span>: <span class="dv">1</span>,</span>
<span id="cb18-112"><a href="#cb18-112" aria-hidden="true" tabindex="-1"></a>        <span class="st">'dtype'</span>: rasterio.uint8,</span>
<span id="cb18-113"><a href="#cb18-113" aria-hidden="true" tabindex="-1"></a>        <span class="st">'crs'</span>: <span class="st">"EPSG:5070"</span>,</span>
<span id="cb18-114"><a href="#cb18-114" aria-hidden="true" tabindex="-1"></a>        <span class="st">'transform'</span>: transform,</span>
<span id="cb18-115"><a href="#cb18-115" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb18-116"><a href="#cb18-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-117"><a href="#cb18-117" aria-hidden="true" tabindex="-1"></a>    arr <span class="op">=</span> np.flipud(points[<span class="st">'is_water'</span>].values.reshape(ys.shape).astype(<span class="bu">int</span>))</span>
<span id="cb18-118"><a href="#cb18-118" aria-hidden="true" tabindex="-1"></a>    arr2 <span class="op">=</span> update_array(arr)</span>
<span id="cb18-119"><a href="#cb18-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-120"><a href="#cb18-120" aria-hidden="true" tabindex="-1"></a>    out_fn <span class="op">=</span> os.path.join(hyd_data_path, <span class="ss">f'</span><span class="sc">{</span>state<span class="sc">}</span><span class="ss">_Waterbody.tif'</span>)</span>
<span id="cb18-121"><a href="#cb18-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-122"><a href="#cb18-122" aria-hidden="true" tabindex="-1"></a>    meta <span class="op">=</span> {</span>
<span id="cb18-123"><a href="#cb18-123" aria-hidden="true" tabindex="-1"></a>        <span class="st">'driver'</span>: <span class="st">'GTiff'</span>,</span>
<span id="cb18-124"><a href="#cb18-124" aria-hidden="true" tabindex="-1"></a>        <span class="st">'height'</span>: ys.shape[<span class="dv">0</span>],</span>
<span id="cb18-125"><a href="#cb18-125" aria-hidden="true" tabindex="-1"></a>        <span class="st">'width'</span>: xs.shape[<span class="dv">1</span>],</span>
<span id="cb18-126"><a href="#cb18-126" aria-hidden="true" tabindex="-1"></a>        <span class="st">'count'</span>: <span class="dv">1</span>,</span>
<span id="cb18-127"><a href="#cb18-127" aria-hidden="true" tabindex="-1"></a>        <span class="st">'dtype'</span>: rasterio.float32,</span>
<span id="cb18-128"><a href="#cb18-128" aria-hidden="true" tabindex="-1"></a>        <span class="st">'crs'</span>: <span class="st">"EPSG:5070"</span>,</span>
<span id="cb18-129"><a href="#cb18-129" aria-hidden="true" tabindex="-1"></a>        <span class="st">'transform'</span>: transform,</span>
<span id="cb18-130"><a href="#cb18-130" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb18-131"><a href="#cb18-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-132"><a href="#cb18-132" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Writing final raster for </span><span class="sc">{</span>state<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb18-133"><a href="#cb18-133" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> rasterio.<span class="bu">open</span>(out_fn, <span class="st">'w'</span>, <span class="op">**</span>meta) <span class="im">as</span> dst:</span>
<span id="cb18-134"><a href="#cb18-134" aria-hidden="true" tabindex="-1"></a>        dst.write(arr2.astype(rasterio.float32), <span class="dv">1</span>)</span>
<span id="cb18-135"><a href="#cb18-135" aria-hidden="true" tabindex="-1"></a>        dst.nodata <span class="op">=</span> <span class="op">-</span><span class="fl">1.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="3" type="1">
<li>Load coast data
<ol type="a">
<li>Apply 5000 Meter buffer to lines to convert to polygons</li>
</ol></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Import libraries</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> arcpy</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>arcpy.analysis.Buffer(<span class="st">"../data/hydrography/Coastline.shp"</span>, </span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"../data/hydrography/Coastline_Buffer.shp"</span>, </span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"5000 Meters"</span>, dissolve_option<span class="op">=</span><span class="st">"ALL"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b. Convert buffered coastline to raster</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Import libraries</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rasterio.transform <span class="im">import</span> from_origin</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rasterio</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shapely.geometry <span class="im">import</span> Point</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Define your desired resolution</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>resolution <span class="op">=</span> <span class="dv">2500</span>  <span class="co"># in the same units as your CRS</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the coastline buffer shapefile</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>coastline_buffer <span class="op">=</span> gpd.read_file(<span class="st">'../data/hydrography/Coastline_Buffer.shp'</span>)</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Reproject the coastline buffer to the desired CRS</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>coastline_buffer <span class="op">=</span> coastline_buffer.to_crs(<span class="st">'EPSG:5070'</span>)</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine the extent of the coastline buffer</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>xmin, ymin, xmax, ymax <span class="op">=</span> coastline_buffer.total_bounds</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a grid of points within this extent</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>ys, xs <span class="op">=</span> np.mgrid[ymin:ymax:resolution, xmin:xmax:resolution]</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>points <span class="op">=</span> gpd.GeoDataFrame(geometry<span class="op">=</span>[Point(x, y) <span class="cf">for</span> x, y <span class="kw">in</span> <span class="bu">zip</span>(xs.flatten(), ys.flatten())], </span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>                          crs<span class="op">=</span><span class="st">"EPSG:5070"</span>)</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign each point a value based on whether it falls within the coastline buffer polygon or not</span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>points[<span class="st">'is_buffer'</span>] <span class="op">=</span> gpd.sjoin(points, </span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>                                coastline_buffer, </span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>                                predicate<span class="op">=</span><span class="st">'within'</span>, </span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>                                how<span class="op">=</span><span class="st">'left'</span>)[<span class="st">'index_right'</span>].notna().astype(<span class="bu">int</span>)</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the output filename</span></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>out_fn <span class="op">=</span> <span class="st">'../data/hydrography/Coastline_Buffer_Raster.tif'</span></span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a raster from these points</span></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>transform <span class="op">=</span> from_origin(xmin, ymax, resolution, resolution)  <span class="co"># rasterio transform (Affine object)</span></span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>meta <span class="op">=</span> {</span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">'driver'</span>: <span class="st">'GTiff'</span>,</span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>    <span class="st">'height'</span>: ys.shape[<span class="dv">0</span>],</span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>    <span class="st">'width'</span>: xs.shape[<span class="dv">1</span>],</span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>    <span class="st">'count'</span>: <span class="dv">1</span>,</span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>    <span class="st">'dtype'</span>: rasterio.uint8,</span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>    <span class="st">'crs'</span>: <span class="st">"EPSG:5070"</span>,</span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>    <span class="st">'transform'</span>: transform,</span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>arr <span class="op">=</span> np.flipud(points[<span class="st">'is_buffer'</span>].values.reshape(ys.shape).astype(<span class="bu">int</span>))</span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> rasterio.<span class="bu">open</span>(out_fn, <span class="st">'w'</span>, <span class="op">**</span>meta) <span class="im">as</span> dst:</span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a>    dst.write(arr.astype(rasterio.uint8), <span class="dv">1</span>)</span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a>    dst.nodata <span class="op">=</span> <span class="dv">255</span></span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Raster file created successfully!"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c.&nbsp;Apply <a href="#general-raster-pre-processing-steps">general raster pre-Processing steps</a> to intermediate raster</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>general_raster_preprocessing(</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    raster_name<span class="op">=</span><span class="st">"hydrography"</span>, </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    out_raster_name<span class="op">=</span><span class="st">"coastline"</span>,</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    out_path<span class="op">=</span><span class="st">"../data/hydrography"</span>,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    wildcard<span class="op">=</span><span class="st">"Coastline_Buffer*"</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="soil" class="level3">
<h3 class="anchored" data-anchor-id="soil">Soil</h3>
<p>Soil Pre-Processing Steps:</p>
<ol type="1">
<li>Load soil shapefile</li>
<li>Create new field called “MUSYM_CODE” using the “MUSYM” field that maps each unique value to an integer</li>
<li>Define raster pixel size, extent; Initialize raster data using GDAL <code>SetGeoTransform</code></li>
<li>Set raster projection using original source spatial reference</li>
<li>Output to (intermediate) raster using GDAL <code>RasterizeLayer</code>, with <code>options=["ATTRIBUTE=MUSYM_CODE"]</code></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Import libraries</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> osgeo <span class="im">import</span> gdal, ogr</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Open the data source</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>vector_ds <span class="op">=</span> <span class="st">"../data/soil/wss_gsmsoil_US_[2016-10-13]/spatial/gsmsoilmu_a_us.shp"</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>raster_fn <span class="op">=</span> <span class="st">"../data/soil/raster/gsmsoilmu_a_us.tif"</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> shp_to_raster(vector_ds, raster_fn, akey):</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    vector_ds <span class="op">=</span> ogr.Open(vector_ds)</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    layer <span class="op">=</span> vector_ds.GetLayer()</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create the destination data source</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    pixel_size <span class="op">=</span> <span class="fl">0.01</span>  <span class="co"># Define this according to your needs</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    x_min, x_max, y_min, y_max <span class="op">=</span> layer.GetExtent()</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    size_x <span class="op">=</span> <span class="bu">int</span>((x_max <span class="op">-</span> x_min) <span class="op">/</span> pixel_size)</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>    size_y <span class="op">=</span> <span class="bu">int</span>((y_max <span class="op">-</span> y_min) <span class="op">/</span> pixel_size)</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create the raster dataset</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>    raster_ds <span class="op">=</span> gdal.GetDriverByName(<span class="st">'GTiff'</span>).Create(raster_fn, size_x, size_y, <span class="dv">1</span>, gdal.GDT_Float32)</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>    raster_ds.SetGeoTransform((x_min, pixel_size, <span class="dv">0</span>, y_max, <span class="dv">0</span>, <span class="op">-</span>pixel_size))</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add a spatial reference</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>    srs <span class="op">=</span> layer.GetSpatialRef()</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>    raster_ds.SetProjection(srs.ExportToWkt())</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rasterize</span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>    gdal.RasterizeLayer(raster_ds, [<span class="dv">1</span>], layer, options<span class="op">=</span>[<span class="ss">f"ATTRIBUTE=</span><span class="sc">{</span>akey<span class="sc">}</span><span class="ss">"</span>])</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Close datasets</span></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>    raster_ds <span class="op">=</span> <span class="va">None</span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>    vector_ds <span class="op">=</span> <span class="va">None</span></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the shapefile into a GeoDataFrame</span></span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>gdf <span class="op">=</span> gpd.read_file(<span class="st">"../data/soil/wss_gsmsoil_US_[2016-10-13]/spatial/gsmsoilmu_a_us.shp"</span>)</span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a DataFrame that maps each unique MUSYM to a unique integer</span></span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>musym_codes <span class="op">=</span> pd.DataFrame({<span class="st">'MUSYM'</span>: gdf[<span class="st">'MUSYM'</span>].unique()})</span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>musym_codes[<span class="st">'MUSYM_CODE'</span>] <span class="op">=</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(musym_codes) <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge the MUSYM_CODE field into the GeoDataFrame</span></span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a>gdf <span class="op">=</span> gdf.merge(musym_codes, on<span class="op">=</span><span class="st">'MUSYM'</span>)</span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the GeoDataFrame back to a shapefile</span></span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a>gdf.to_file(<span class="st">"../data/soil/codes/gsmsoilmu_a_us.shp"</span>)</span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a>vector_ds <span class="op">=</span> <span class="st">"../data/soil/codes/gsmsoilmu_a_us.shp"</span></span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a>raster_fn <span class="op">=</span> <span class="st">"../data/soil/raster/gsmsoilmu_a_us.tif"</span></span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a>shp_to_raster(vector_ds, raster_fn, akey<span class="op">=</span><span class="st">"MUSYM_CODE"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="6" type="1">
<li>Apply <a href="#general-raster-pre-processing-steps">general raster pre-Processing steps</a> to intermediate raster</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>general_raster_preprocessing(</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    raster_name<span class="op">=</span><span class="st">"soil"</span>, </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    out_raster_name<span class="op">=</span><span class="st">"soil"</span>,</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    out_path<span class="op">=</span><span class="st">"../data/soil"</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="vegetation-index" class="level3">
<h3 class="anchored" data-anchor-id="vegetation-index">Vegetation Index</h3>
<p>Vegetation Index Pre-Processing Steps:</p>
<ol type="1">
<li>For each seasonal raster, (spring, summer, fall, winter), apply the <a href="#general-raster-pre-processing-steps">general raster pre-processing steps</a></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterate through each season</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> season <span class="kw">in</span> [<span class="st">"Spring"</span>, <span class="st">"Summer"</span>, <span class="st">"Fall"</span>, <span class="st">"Winter"</span>]:</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Applying raster preprocessing for </span><span class="sc">{</span>season<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Using the combined raster, apply "general raster preprocessing" (resample, reproject, mask)</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>        general_raster_preprocessing(</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>            raster_name<span class="op">=</span><span class="ss">f"NDVI/US_eVSH_NDVI-</span><span class="sc">{</span>season<span class="sc">}</span><span class="ss">-2021"</span>, </span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>            out_raster_name<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>season<span class="sc">}</span><span class="ss">_NDVI"</span>,</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>            out_path<span class="op">=</span><span class="st">"../data/NDVI"</span>,</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>            wildcard<span class="op">=</span><span class="st">"*1KM.VI_NDVI*"</span>, </span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>            raster_type<span class="op">=</span><span class="st">"TIF"</span>)</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"-----------------"</span>)</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"An error occurred while processing </span><span class="sc">{</span>season<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Finished."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="2" type="1">
<li>Re-scale (divide each value by 10,000, according the USGS specifications)</li>
</ol>
<p><em>NOT CURRENTLY BEING USED</em></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Import libraries</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rasterio</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> season <span class="kw">in</span> [<span class="st">"Spring"</span>, <span class="st">"Summer"</span>, <span class="st">"Fall"</span>, <span class="st">"Winter"</span>]:</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> state <span class="kw">in</span> [<span class="st">"CO"</span>, <span class="st">"NC"</span>, <span class="st">"OR"</span>, <span class="st">"VT"</span>]:</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>        raster_path <span class="op">=</span> <span class="ss">f"../data/NDVI/</span><span class="sc">{</span>season<span class="sc">}</span><span class="ss">_NDVI_</span><span class="sc">{</span>state<span class="sc">}</span><span class="ss">.tif"</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Open the raster file</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> rasterio.<span class="bu">open</span>(raster_path) <span class="im">as</span> src:</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Read the data from the raster</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>            data <span class="op">=</span> src.read()</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Divide the raster values by 10,000</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>            rescaled_data <span class="op">=</span> data <span class="op">/</span> <span class="fl">10000.0</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Parameters for saving</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>            kwargs <span class="op">=</span> src.meta</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>            kwargs.update(dtype<span class="op">=</span>rescaled_data.dtype)</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Save the rescaled data back to the same raster file (overwriting)</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> rasterio.<span class="bu">open</span>(raster_path, <span class="st">'w'</span>, <span class="op">**</span>kwargs) <span class="im">as</span> dest:</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>            dest.write(rescaled_data)</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'Rescaled </span><span class="sc">{</span>season<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>state<span class="sc">}</span><span class="ss"> raster saved at </span><span class="sc">{</span>raster_path<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Finished rescaling rasters."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<br>
<hr>
</section>
<section id="final-pre-processing-steps-ensuring-shapesize-conformity" class="level3">
<h3 class="anchored" data-anchor-id="final-pre-processing-steps-ensuring-shapesize-conformity">Final Pre-Processing Steps (Ensuring Shape/Size Conformity)</h3>
<ol type="1">
<li>Create dictionary of all rasters:</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_file_paths_dict(</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    base_path <span class="op">=</span> <span class="st">"../data"</span>,</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    states <span class="op">=</span> [<span class="st">"CO"</span>, <span class="st">"NC"</span>, <span class="st">"OR"</span>, <span class="st">"VT"</span>],</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    categories <span class="op">=</span> [</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"canopy/canopy_"</span>,</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"dem/dem_"</span>,</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"hydrography/coastline_"</span>,</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"hydrography/Waterbody"</span>,</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"land_cover/land_cover_"</span>,</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"NDVI/Fall_NDVI_"</span>,</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"NDVI/Spring_NDVI_"</span>,</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"NDVI/Summer_NDVI_"</span>,</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"NDVI/Winter_NDVI_"</span>,</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"soil/soil_"</span>,</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"urban_imperviousness/urban_imperviousness_"</span>,</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"weather/ppt_"</span>,</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"weather/tmax_"</span>,</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"weather/tmin_"</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>    ], verbose<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Dictionary to store paths</span></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>    file_paths_dict <span class="op">=</span> {}</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Loop through each category and state, and construct the file path</span></span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> category <span class="kw">in</span> categories:</span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract the category name for the outer dictionary key</span></span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>        category_name <span class="op">=</span> category.split(<span class="st">'/'</span>)[<span class="dv">0</span>]</span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> category_name <span class="kw">not</span> <span class="kw">in</span> file_paths_dict:</span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>            file_paths_dict[category_name] <span class="op">=</span> {}</span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract the filename prefix for the inner dictionary key</span></span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>        filename_prefix <span class="op">=</span> category.split(<span class="st">'/'</span>)[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> state <span class="kw">in</span> states:</span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Handle special cases for 'Waterbody'</span></span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> filename_prefix <span class="op">==</span> <span class="st">"Waterbody"</span>:</span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a>                file_path <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>base_path<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>category_name<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>state<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>filename_prefix<span class="sc">}</span><span class="ss">.tif"</span></span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a>                file_path <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>base_path<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>category<span class="sc">}{</span>state<span class="sc">}</span><span class="ss">.tif"</span></span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Add the file path to the inner dictionary</span></span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a>            inner_key <span class="op">=</span> filename_prefix.rstrip(<span class="st">'_'</span>)</span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> inner_key <span class="kw">not</span> <span class="kw">in</span> file_paths_dict[category_name]:</span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a>                file_paths_dict[category_name][inner_key] <span class="op">=</span> {}</span>
<span id="cb26-45"><a href="#cb26-45" aria-hidden="true" tabindex="-1"></a>            file_paths_dict[category_name][inner_key][state] <span class="op">=</span> file_path</span>
<span id="cb26-46"><a href="#cb26-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-47"><a href="#cb26-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> verbose:</span>
<span id="cb26-48"><a href="#cb26-48" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Print the dictionary</span></span>
<span id="cb26-49"><a href="#cb26-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> category, filenames <span class="kw">in</span> file_paths_dict.items():</span>
<span id="cb26-50"><a href="#cb26-50" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>category<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb26-51"><a href="#cb26-51" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> filename, state_paths <span class="kw">in</span> filenames.items():</span>
<span id="cb26-52"><a href="#cb26-52" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"    </span><span class="sc">{</span>filename<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb26-53"><a href="#cb26-53" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> state, file_path <span class="kw">in</span> state_paths.items():</span>
<span id="cb26-54"><a href="#cb26-54" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f"        </span><span class="sc">{</span>state<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>file_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb26-55"><a href="#cb26-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>(file_paths_dict)</span>
<span id="cb26-56"><a href="#cb26-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-57"><a href="#cb26-57" aria-hidden="true" tabindex="-1"></a>file_paths_dict <span class="op">=</span> get_file_paths_dict(verbose<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="2" type="1">
<li>Check for dimension conformity:</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Import libraries</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rasterio</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through the categories (e.g., canopy, dem)</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> category, subcategories <span class="kw">in</span> file_paths_dict.items():</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>category<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Loop through the subcategories (e.g., canopy, dem)</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> subcategory, states <span class="kw">in</span> subcategories.items():</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"    </span><span class="sc">{</span>subcategory<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Loop through the states (e.g., CO, NC)</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> state, file_path <span class="kw">in</span> states.items():</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Open the file using rasterio</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>                <span class="cf">with</span> rasterio.<span class="bu">open</span>(file_path) <span class="im">as</span> raster:</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f"        </span><span class="sc">{</span>state<span class="sc">}</span><span class="ss"> dimensions: </span><span class="sc">{</span>raster<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"        </span><span class="sc">{</span>state<span class="sc">}</span><span class="ss">: Could not read file. </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Example Output:</span></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a><span class="co"># canopy:</span></span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a><span class="co">#     canopy:</span></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a><span class="co">#         CO dimensions: (204, 258)</span></span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a><span class="co">#         NC dimensions: (138, 313)</span></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a><span class="co">#         OR dimensions: (243, 285)</span></span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a><span class="co">#         VT dimensions: (114, 61)</span></span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a><span class="co"># dem:</span></span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a><span class="co">#     dem:</span></span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a><span class="co">#         CO dimensions: (204, 258)</span></span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a><span class="co">#         NC dimensions: (138, 312)</span></span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a><span class="co">#         OR dimensions: (243, 285)</span></span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a><span class="co">#         VT dimensions: (114, 61)</span></span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a><span class="co"># ...</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="3" type="1">
<li>Define a function to resample and transform rasters</li>
<li>Loop through rasters, and apply resampling and transformation</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rasterio</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rasterio.warp <span class="im">import</span> calculate_default_transform, reproject, Resampling</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rasterio.mask <span class="im">import</span> mask</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rasterio.shutil <span class="im">import</span> copy</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm <span class="im">import</span> tqdm</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>dst_crs <span class="op">=</span> <span class="st">'EPSG:5070'</span>  <span class="co"># CRS for your target raster</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>states <span class="op">=</span> [<span class="st">"CO"</span>, <span class="st">"NC"</span>, <span class="st">"OR"</span>, <span class="st">"VT"</span>]</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>data_path <span class="op">=</span> <span class="st">"../data"</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> resample_raster(src_path, dst_path, dst_crs, target, resampling<span class="op">=</span>Resampling.nearest):</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> rasterio.<span class="bu">open</span>(target) <span class="im">as</span> tar:</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>        target_transform, target_width, target_height <span class="op">=</span> calculate_default_transform(tar.crs, dst_crs, tar.width, tar.height, <span class="op">*</span>tar.bounds)</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>        mask_geom <span class="op">=</span> [{<span class="st">'type'</span>: <span class="st">'Polygon'</span>, <span class="st">'coordinates'</span>: [[</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>            [tar.bounds.left, tar.bounds.bottom],</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>            [tar.bounds.left, tar.bounds.top],</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>            [tar.bounds.right, tar.bounds.top],</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>            [tar.bounds.right, tar.bounds.bottom],</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>            [tar.bounds.left, tar.bounds.bottom]</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>        ]]}]</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> rasterio.<span class="bu">open</span>(src_path) <span class="im">as</span> src:</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>        transform, width, height <span class="op">=</span> calculate_default_transform(src.crs, dst_crs, src.width, src.height, <span class="op">*</span>src.bounds)</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>        kwargs <span class="op">=</span> src.meta.copy()</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>        kwargs.update({</span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>            <span class="st">'crs'</span>: dst_crs,</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>            <span class="st">'transform'</span>: target_transform,</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>            <span class="st">'width'</span>: target_width,</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>            <span class="st">'height'</span>: target_height,</span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>            <span class="st">'nodata'</span>: src.nodata  <span class="co"># use the original's nodata value</span></span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> rasterio.<span class="bu">open</span>(dst_path, <span class="st">'w'</span>, <span class="op">**</span>kwargs) <span class="im">as</span> dst:</span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, src.count <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>                reproject(</span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>                    source<span class="op">=</span>rasterio.band(src, i),</span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>                    destination<span class="op">=</span>rasterio.band(dst, i),</span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a>                    src_transform<span class="op">=</span>src.transform,</span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a>                    src_crs<span class="op">=</span>src.crs,</span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a>                    dst_transform<span class="op">=</span>target_transform,</span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a>                    dst_crs<span class="op">=</span>dst_crs,</span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a>                    resampling<span class="op">=</span>resampling)</span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply the mask in a separate step</span></span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> rasterio.<span class="bu">open</span>(dst_path, <span class="st">'r+'</span>) <span class="im">as</span> dst:  <span class="co"># Open in read/write mode</span></span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a>        out_image, out_transform <span class="op">=</span> mask(dst, mask_geom, crop<span class="op">=</span><span class="va">True</span>, nodata<span class="op">=</span>dst.nodata)</span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true" tabindex="-1"></a>        dst.write(out_image)</span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a>        dst.transform <span class="op">=</span> out_transform</span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true" tabindex="-1"></a>target_raster <span class="op">=</span> file_paths_dict[<span class="st">"NDVI"</span>][<span class="st">"Fall_NDVI"</span>] <span class="co"># The raster to match</span></span>
<span id="cb28-55"><a href="#cb28-55" aria-hidden="true" tabindex="-1"></a>outpath <span class="op">=</span> os.path.join(data_path, <span class="st">"rasters"</span>)</span>
<span id="cb28-56"><a href="#cb28-56" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(outpath):</span>
<span id="cb28-57"><a href="#cb28-57" aria-hidden="true" tabindex="-1"></a>    os.mkdir(outpath)</span>
<span id="cb28-58"><a href="#cb28-58" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> category, subcategories <span class="kw">in</span> file_paths_dict.items():</span>
<span id="cb28-59"><a href="#cb28-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Loop through the subcategories (e.g., canopy, dem)</span></span>
<span id="cb28-60"><a href="#cb28-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> subcategory, states <span class="kw">in</span> subcategories.items():</span>
<span id="cb28-61"><a href="#cb28-61" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Loop through the states (e.g., CO, NC)</span></span>
<span id="cb28-62"><a href="#cb28-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> state, source_raster <span class="kw">in</span> states.items():</span>
<span id="cb28-63"><a href="#cb28-63" aria-hidden="true" tabindex="-1"></a>            raster_name <span class="op">=</span> os.path.basename(source_raster).replace(<span class="st">".tif"</span>, <span class="st">""</span>)</span>
<span id="cb28-64"><a href="#cb28-64" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Resampling and transforming </span><span class="sc">{</span>raster_name<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb28-65"><a href="#cb28-65" aria-hidden="true" tabindex="-1"></a>            destination_raster <span class="op">=</span> os.path.join(outpath, raster_name <span class="op">+</span> <span class="st">'.tif'</span>)  <span class="co"># The output path</span></span>
<span id="cb28-66"><a href="#cb28-66" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> source_raster <span class="op">==</span> target_raster[state]:  <span class="co"># if source raster is the same as target raster</span></span>
<span id="cb28-67"><a href="#cb28-67" aria-hidden="true" tabindex="-1"></a>                copy(source_raster, destination_raster)  <span class="co"># just copy the raster to the outpath</span></span>
<span id="cb28-68"><a href="#cb28-68" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb28-69"><a href="#cb28-69" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="st">"land_cover"</span> <span class="kw">in</span> raster_name <span class="kw">or</span> <span class="st">"soil"</span> <span class="kw">in</span> raster_name:</span>
<span id="cb28-70"><a href="#cb28-70" aria-hidden="true" tabindex="-1"></a>                    resampling <span class="op">=</span> Resampling.nearest</span>
<span id="cb28-71"><a href="#cb28-71" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb28-72"><a href="#cb28-72" aria-hidden="true" tabindex="-1"></a>                    resampling <span class="op">=</span> Resampling.bilinear</span>
<span id="cb28-73"><a href="#cb28-73" aria-hidden="true" tabindex="-1"></a>                resample_raster(source_raster, destination_raster, dst_crs, target_raster[state], resampling)</span>
<span id="cb28-74"><a href="#cb28-74" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Fixing land cover NA values..."</span>)</span>
<span id="cb28-75"><a href="#cb28-75" aria-hidden="true" tabindex="-1"></a><span class="co"># Fix land cover na values (they git a little messed up from the resampling)</span></span>
<span id="cb28-76"><a href="#cb28-76" aria-hidden="true" tabindex="-1"></a>fix_lc_na(data_path<span class="op">=</span><span class="st">"../data/rasters"</span>, na_val<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb28-77"><a href="#cb28-77" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Finished."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="5" type="1">
<li>Check that all shapes match (by state):</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>folder_path <span class="op">=</span> <span class="st">'../data/rasters'</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through all the files in the folder</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> file_name <span class="kw">in</span> os.listdir(folder_path):</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if the file is a .tif file</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> file_name.endswith(<span class="st">'.tif'</span>):</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Construct the full file path</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>        file_path <span class="op">=</span> os.path.join(folder_path, file_name)</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Open the raster file</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> rasterio.<span class="bu">open</span>(file_path) <span class="im">as</span> src:</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Print the shape of the raster file</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f'Shape of </span><span class="sc">{</span>file_name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>src<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="combining-the-data-feature-extraction" class="level2">
<h2 class="anchored" data-anchor-id="combining-the-data-feature-extraction">Combining the Data (Feature Extraction)</h2>
<ol type="1">
<li>Load preprocessed observation point data</li>
<li>Sort by distance from center</li>
<li>Ensure correct CRS</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Import libraries</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shapely.geometry <span class="im">import</span> Point</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>data_path <span class="op">=</span> <span class="st">'../data/'</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>states <span class="op">=</span> [<span class="st">"CO"</span>, <span class="st">"NC"</span>, <span class="st">"OR"</span>, <span class="st">"VT"</span>]</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> state <span class="kw">in</span> states:</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    input_name <span class="op">=</span> <span class="st">"observations_"</span> <span class="op">+</span> state <span class="op">+</span> <span class="st">".csv"</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    output_file <span class="op">=</span> <span class="st">"observations_"</span> <span class="op">+</span> state <span class="op">+</span> <span class="st">".shp"</span> </span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Reading </span><span class="sc">{</span>state<span class="sc">}</span><span class="ss"> data..."</span>)</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>    bird_data_path <span class="op">=</span> os.path.join(data_path, input_name)</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(bird_data_path)</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert the bird data to a GeoDataFrame</span></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Converting </span><span class="sc">{</span>state<span class="sc">}</span><span class="ss"> data to geodf..."</span>)</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>    geometry <span class="op">=</span> [Point(xy) <span class="cf">for</span> xy <span class="kw">in</span> <span class="bu">zip</span>(df[<span class="st">'longitude'</span>], df[<span class="st">'latitude'</span>])]</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>    geo_df <span class="op">=</span> gpd.GeoDataFrame(df, geometry<span class="op">=</span>geometry, crs<span class="op">=</span><span class="st">'EPSG:4326'</span>)</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define target CRS</span></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Updating CRS for </span><span class="sc">{</span>state<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>    target_crs <span class="op">=</span> <span class="st">"EPSG:5070"</span></span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If the bird data is not in the correct CRS, convert it</span></span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> geo_df.crs.to_string() <span class="op">!=</span> target_crs:</span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>        geo_df <span class="op">=</span> geo_df.to_crs(target_crs)</span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Getting centroid of </span><span class="sc">{</span>state<span class="sc">}</span><span class="ss"> data..."</span>)</span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get centroid of the entire sightings</span></span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>    centroid <span class="op">=</span> geo_df.geometry.centroid.unary_union.centroid</span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Calculating distances from centroid for </span><span class="sc">{</span>state<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Assign each point a distance attribute, being the distance from the centroid</span></span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>    geo_df[<span class="st">'distance'</span>] <span class="op">=</span> geo_df.geometry.distance(centroid)</span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Sorting by distance from centroid in </span><span class="sc">{</span>state<span class="sc">}</span><span class="ss"> data..."</span>)</span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort the GeoDataFrame by the distance attribute</span></span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a>    geo_df.sort_values(by<span class="op">=</span><span class="st">'distance'</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Saving </span><span class="sc">{</span>state<span class="sc">}</span><span class="ss"> data to </span><span class="sc">{</span>output_file<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Drop the distance attribute (we don't need it anymore)</span></span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a>    geo_df.drop(columns<span class="op">=</span><span class="st">'distance'</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a>    geo_df.to_file(os.path.join(data_path, output_file))</span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"--------------"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="2" type="1">
<li>Define pre-processed raster paths; Use <code>arcpy.sa.ExtractMultiValuesToPoints</code> to extract raster values to the points in the bird data
<ul>
<li>canopy, dem, coast, waterbody, land_cover, soil, urban_imp, avg_prcp, max_tmp, min_tmp, ndvi_spring, ndvi_summer, ndvi_fall, ndvi_winter</li>
</ul></li>
<li>Use <code>arcpy.analysis.Select</code> to select points that have non-null raster values for all raster layers</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Import libraries</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os </span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> arcpy</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> arcpy.sa <span class="im">import</span> <span class="op">*</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> csv</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>data_path <span class="op">=</span> <span class="st">'../data/'</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Set environment settings</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>arcpy.env.workspace <span class="op">=</span> data_path</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>arcpy.env.overwriteOutput <span class="op">=</span> <span class="va">True</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>states <span class="op">=</span> [<span class="st">"CO"</span>, <span class="st">"NC"</span>, <span class="st">"OR"</span>, <span class="st">"VT"</span>]</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Define your target CRS</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>target_crs <span class="op">=</span> arcpy.SpatialReference(<span class="dv">5070</span>)  <span class="co"># The SpatialReference should be initiated with an EPSG code</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> state <span class="kw">in</span> states:</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>    input_name <span class="op">=</span> <span class="st">"observations_"</span> <span class="op">+</span> state <span class="op">+</span> <span class="st">".shp"</span> </span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>    out_name <span class="op">=</span> <span class="st">"all_data_"</span> <span class="op">+</span> state <span class="op">+</span> <span class="st">".shp"</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>    output_no_null <span class="op">=</span> <span class="st">"all_data_no_null_"</span> <span class="op">+</span> state <span class="op">+</span> <span class="st">".shp"</span></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set the path for the output CSV file</span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>    csvfile <span class="op">=</span> os.path.join(data_path, <span class="st">"final_data_"</span> <span class="op">+</span> state <span class="op">+</span> <span class="st">".csv"</span>)</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Final raster paths</span></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>    raster_path <span class="op">=</span> os.path.join(data_path, <span class="st">"rasters"</span>)</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>    raster_paths <span class="op">=</span> <span class="bu">dict</span>()</span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Loop through all the files in the folder</span></span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> file_name <span class="kw">in</span> os.listdir(raster_path):</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check if the file is a .tif file</span></span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> file_name.endswith(<span class="st">'.tif'</span>) <span class="kw">and</span> state <span class="kw">in</span> file_name:</span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>            raster_name <span class="op">=</span> os.path.basename(file_name).replace(<span class="st">".tif"</span>, <span class="st">""</span>).replace(<span class="st">"_"</span> <span class="op">+</span> state, <span class="st">""</span>).replace(state <span class="op">+</span> <span class="st">"_"</span>, <span class="st">""</span>)</span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Construct the full file path</span></span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>            file_path <span class="op">=</span> os.path.join(raster_path, file_name)</span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>            raster_paths.update({raster_name:file_path})</span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a>    raster_str <span class="op">=</span> <span class="st">";"</span>.join([<span class="ss">f"</span><span class="sc">{</span>p<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> k, p <span class="kw">in</span> raster_paths.items()])</span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Extracting points to values for </span><span class="sc">{</span>state<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a>    points <span class="op">=</span> arcpy.sa.ExtractMultiValuesToPoints(</span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a>        input_name, </span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a>        raster_str, </span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a>        <span class="st">"NONE"</span></span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Selecting non-null points for </span><span class="sc">{</span>state<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a>    query <span class="op">=</span> <span class="st">"AND "</span>.join([r_name[:<span class="dv">10</span>] <span class="op">+</span> <span class="st">" IS NOT NULL "</span> <span class="cf">for</span> r_name <span class="kw">in</span> raster_paths.keys()]) </span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true" tabindex="-1"></a>    no_null <span class="op">=</span> arcpy.analysis.Select(input_name, output_no_null, query)</span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-48"><a href="#cb31-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get the fields from the feature class</span></span>
<span id="cb31-49"><a href="#cb31-49" aria-hidden="true" tabindex="-1"></a>    fields <span class="op">=</span> arcpy.ListFields(output_no_null)</span>
<span id="cb31-50"><a href="#cb31-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-51"><a href="#cb31-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a list to hold the field names</span></span>
<span id="cb31-52"><a href="#cb31-52" aria-hidden="true" tabindex="-1"></a>    fieldnames <span class="op">=</span> [field.name <span class="cf">for</span> field <span class="kw">in</span> fields]</span>
<span id="cb31-53"><a href="#cb31-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-54"><a href="#cb31-54" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Saving </span><span class="sc">{</span>state<span class="sc">}</span><span class="ss"> final data to csv..."</span>)</span>
<span id="cb31-55"><a href="#cb31-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Open the CSV file and write the data from the feature class</span></span>
<span id="cb31-56"><a href="#cb31-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(csvfile, <span class="st">'w'</span>) <span class="im">as</span> f:</span>
<span id="cb31-57"><a href="#cb31-57" aria-hidden="true" tabindex="-1"></a>        writer <span class="op">=</span> csv.writer(f)</span>
<span id="cb31-58"><a href="#cb31-58" aria-hidden="true" tabindex="-1"></a>        writer.writerow(fieldnames)  <span class="co"># write the field names</span></span>
<span id="cb31-59"><a href="#cb31-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> arcpy.da.SearchCursor(output_no_null, fieldnames) <span class="im">as</span> cursor:</span>
<span id="cb31-60"><a href="#cb31-60" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> row <span class="kw">in</span> cursor:</span>
<span id="cb31-61"><a href="#cb31-61" aria-hidden="true" tabindex="-1"></a>                writer.writerow(row)</span>
<span id="cb31-62"><a href="#cb31-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fix names</span></span>
<span id="cb31-63"><a href="#cb31-63" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Fixing column names..."</span>)</span>
<span id="cb31-64"><a href="#cb31-64" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(csvfile)</span>
<span id="cb31-65"><a href="#cb31-65" aria-hidden="true" tabindex="-1"></a>    df.rename(columns<span class="op">=</span>{<span class="st">"common_nam"</span>:<span class="st">"common_name"</span>,</span>
<span id="cb31-66"><a href="#cb31-66" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"observatio"</span>:<span class="st">"observations"</span>,</span>
<span id="cb31-67"><a href="#cb31-67" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"Spring_NDV"</span>:<span class="st">"ndvi_spring"</span>,</span>
<span id="cb31-68"><a href="#cb31-68" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"Summer_NDV"</span>:<span class="st">"ndvi_summer"</span>,</span>
<span id="cb31-69"><a href="#cb31-69" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"Winter_NDV"</span>:<span class="st">"ndvi_winter"</span>,</span>
<span id="cb31-70"><a href="#cb31-70" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"Fall_NDVI"</span>:<span class="st">"ndvi_fall"</span>,</span>
<span id="cb31-71"><a href="#cb31-71" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"urban_impe"</span>:<span class="st">"urban_imperviousness"</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-72"><a href="#cb31-72" aria-hidden="true" tabindex="-1"></a>    df.to_csv(csvfile, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb31-73"><a href="#cb31-73" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'</span><span class="sc">{</span>state<span class="sc">}</span><span class="ss"> column names: </span><span class="sc">{</span><span class="st">", "</span><span class="sc">.</span>join(df.columns)<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb31-74"><a href="#cb31-74" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Finished."</span>)</span>
<span id="cb31-75"><a href="#cb31-75" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"--------------"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="4" type="1">
<li>Perform One-Hot Encoding on species (<code>common_name</code>)</li>
<li>Export final result to .csv file</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> state <span class="kw">in</span> states:</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set the path for the CSV file</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    csvfile <span class="op">=</span> os.path.join(data_path, <span class="st">"final_data_"</span> <span class="op">+</span> state <span class="op">+</span> <span class="st">".csv"</span>)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load the CSV file into a DataFrame</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(csvfile)</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Perform one-hot encoding on the "common_name" field</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    one_hot_encoded <span class="op">=</span> pd.get_dummies(df[<span class="st">"common_name"</span>], prefix<span class="op">=</span><span class="st">"species"</span>)</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    one_hot_encoded.columns <span class="op">=</span> one_hot_encoded.columns.<span class="bu">str</span>.lower()</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    one_hot_encoded.columns <span class="op">=</span> one_hot_encoded.columns.<span class="bu">str</span>.replace(<span class="st">" "</span>, <span class="st">"_"</span>).<span class="bu">str</span>.replace(<span class="st">"-"</span>, <span class="st">"_"</span>)</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Concatenate the one-hot encoded DataFrame with the original DataFrame</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>    df_encoded <span class="op">=</span> pd.concat([df, one_hot_encoded], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save the encoded DataFrame to a new CSV file</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>    encoded_csvfile <span class="op">=</span> os.path.join(data_path, <span class="st">"encoded_data_"</span> <span class="op">+</span> state <span class="op">+</span> <span class="st">".csv"</span>)</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>    df_encoded.to_csv(encoded_csvfile, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="final-output-examples" class="level2">
<h2 class="anchored" data-anchor-id="final-output-examples">Final Output Examples</h2>
<section id="data" class="level3">
<h3 class="anchored" data-anchor-id="data">Data</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(<span class="fu">head</span>(readr<span class="sc">::</span><span class="fu">read_csv</span>(<span class="st">"../data/encoded_data_NC.csv"</span>), <span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<caption>Final Data Output (OR) - top 10 records </caption>
<colgroup>
<col style="width: 0%">
<col style="width: 9%">
<col style="width: 4%">
<col style="width: 2%">
<col style="width: 2%">
<col style="width: 3%">
<col style="width: 1%">
<col style="width: 2%">
<col style="width: 1%">
<col style="width: 2%">
<col style="width: 2%">
<col style="width: 2%">
<col style="width: 1%">
<col style="width: 1%">
<col style="width: 2%">
<col style="width: 2%">
<col style="width: 1%">
<col style="width: 1%">
<col style="width: 5%">
<col style="width: 2%">
<col style="width: 6%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 4%">
<col style="width: 4%">
<col style="width: 5%">
<col style="width: 6%">
<col style="width: 4%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">FID</th>
<th style="text-align: left;">Shape</th>
<th style="text-align: left;">common_name</th>
<th style="text-align: right;">latitude</th>
<th style="text-align: right;">longitude</th>
<th style="text-align: right;">observations</th>
<th style="text-align: right;">canopy</th>
<th style="text-align: right;">coastline</th>
<th style="text-align: right;">dem</th>
<th style="text-align: right;">ndvi_fall</th>
<th style="text-align: right;">land_cover</th>
<th style="text-align: right;">Waterbody</th>
<th style="text-align: right;">ppt</th>
<th style="text-align: right;">soil</th>
<th style="text-align: right;">ndvi_spring</th>
<th style="text-align: right;">ndvi_summer</th>
<th style="text-align: right;">tmax</th>
<th style="text-align: right;">tmin</th>
<th style="text-align: right;">urban_imperviousness</th>
<th style="text-align: right;">ndvi_winter</th>
<th style="text-align: right;">species_belted_kingfisher</th>
<th style="text-align: right;">species_cedar_waxwing</th>
<th style="text-align: right;">species_downy_woodpecker</th>
<th style="text-align: right;">species_ruddy_duck</th>
<th style="text-align: right;">species_sanderling</th>
<th style="text-align: right;">species_sandhill_crane</th>
<th style="text-align: right;">species_sharp_shinned_hawk</th>
<th style="text-align: right;">species_wild_turkey</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: left;">(1474330.4464382327, 1516831.1555096118)</td>
<td style="text-align: left;">Wild Turkey</td>
<td style="text-align: right;">35.55229</td>
<td style="text-align: right;">-79.51166</td>
<td style="text-align: right;">12</td>
<td style="text-align: right;">63</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">136.610</td>
<td style="text-align: right;">9068</td>
<td style="text-align: right;">43</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1297.84</td>
<td style="text-align: right;">438</td>
<td style="text-align: right;">6690</td>
<td style="text-align: right;">9537</td>
<td style="text-align: right;">22.9899</td>
<td style="text-align: right;">9.32003</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">6443</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: left;">(1472227.5811435264, 1524078.2747159547)</td>
<td style="text-align: left;">Downy Woodpecker</td>
<td style="text-align: right;">35.61930</td>
<td style="text-align: right;">-79.52080</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">50</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">164.852</td>
<td style="text-align: right;">9144</td>
<td style="text-align: right;">43</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1282.93</td>
<td style="text-align: right;">438</td>
<td style="text-align: right;">5913</td>
<td style="text-align: right;">9226</td>
<td style="text-align: right;">22.7556</td>
<td style="text-align: right;">9.17480</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">6662</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2</td>
<td style="text-align: left;">(1460081.0012807015, 1517290.0132610195)</td>
<td style="text-align: left;">Wild Turkey</td>
<td style="text-align: right;">35.57820</td>
<td style="text-align: right;">-79.66702</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">51</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">167.340</td>
<td style="text-align: right;">9096</td>
<td style="text-align: right;">81</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1359.54</td>
<td style="text-align: right;">438</td>
<td style="text-align: right;">5852</td>
<td style="text-align: right;">8427</td>
<td style="text-align: right;">22.9928</td>
<td style="text-align: right;">9.43411</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">5875</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">3</td>
<td style="text-align: left;">(1474425.4136967321, 1529790.9086959288)</td>
<td style="text-align: left;">Downy Woodpecker</td>
<td style="text-align: right;">35.66617</td>
<td style="text-align: right;">-79.48569</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">57</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">185.356</td>
<td style="text-align: right;">8496</td>
<td style="text-align: right;">41</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1270.97</td>
<td style="text-align: right;">469</td>
<td style="text-align: right;">5941</td>
<td style="text-align: right;">8711</td>
<td style="text-align: right;">22.3727</td>
<td style="text-align: right;">9.06253</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">6117</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">4</td>
<td style="text-align: left;">(1474425.4136967321, 1529790.9086959288)</td>
<td style="text-align: left;">Wild Turkey</td>
<td style="text-align: right;">35.66617</td>
<td style="text-align: right;">-79.48569</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">57</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">185.356</td>
<td style="text-align: right;">8496</td>
<td style="text-align: right;">41</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1270.97</td>
<td style="text-align: right;">469</td>
<td style="text-align: right;">5941</td>
<td style="text-align: right;">8711</td>
<td style="text-align: right;">22.3727</td>
<td style="text-align: right;">9.06253</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">6117</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">5</td>
<td style="text-align: left;">(1458092.8286986717, 1529488.4559911182)</td>
<td style="text-align: left;">Belted Kingfisher</td>
<td style="text-align: right;">35.68860</td>
<td style="text-align: right;">-79.66560</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">41</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">160.690</td>
<td style="text-align: right;">8765</td>
<td style="text-align: right;">81</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1281.74</td>
<td style="text-align: right;">438</td>
<td style="text-align: right;">5747</td>
<td style="text-align: right;">7349</td>
<td style="text-align: right;">22.5577</td>
<td style="text-align: right;">9.17981</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">5010</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">6</td>
<td style="text-align: left;">(1458092.8286986717, 1529488.4559911182)</td>
<td style="text-align: left;">Downy Woodpecker</td>
<td style="text-align: right;">35.68860</td>
<td style="text-align: right;">-79.66560</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">41</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">160.690</td>
<td style="text-align: right;">8765</td>
<td style="text-align: right;">81</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1281.74</td>
<td style="text-align: right;">438</td>
<td style="text-align: right;">5747</td>
<td style="text-align: right;">7349</td>
<td style="text-align: right;">22.5577</td>
<td style="text-align: right;">9.17981</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">5010</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">7</td>
<td style="text-align: left;">(1468330.9449693, 1533766.1784612893)</td>
<td style="text-align: left;">Downy Woodpecker</td>
<td style="text-align: right;">35.71054</td>
<td style="text-align: right;">-79.54496</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">49</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">167.632</td>
<td style="text-align: right;">9116</td>
<td style="text-align: right;">41</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1191.87</td>
<td style="text-align: right;">438</td>
<td style="text-align: right;">7739</td>
<td style="text-align: right;">8993</td>
<td style="text-align: right;">22.4021</td>
<td style="text-align: right;">8.98845</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">6817</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">8</td>
<td style="text-align: left;">(1468330.9449693, 1533766.1784612893)</td>
<td style="text-align: left;">Cedar Waxwing</td>
<td style="text-align: right;">35.71054</td>
<td style="text-align: right;">-79.54496</td>
<td style="text-align: right;">18</td>
<td style="text-align: right;">49</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">167.632</td>
<td style="text-align: right;">9116</td>
<td style="text-align: right;">41</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1191.87</td>
<td style="text-align: right;">438</td>
<td style="text-align: right;">7739</td>
<td style="text-align: right;">8993</td>
<td style="text-align: right;">22.4021</td>
<td style="text-align: right;">8.98845</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">6817</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">9</td>
<td style="text-align: left;">(1452677.3206835638, 1521192.5622494498)</td>
<td style="text-align: left;">Wild Turkey</td>
<td style="text-align: right;">35.62384</td>
<td style="text-align: right;">-79.74083</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">65</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">186.750</td>
<td style="text-align: right;">9571</td>
<td style="text-align: right;">41</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1360.48</td>
<td style="text-align: right;">509</td>
<td style="text-align: right;">5157</td>
<td style="text-align: right;">9822</td>
<td style="text-align: right;">22.5442</td>
<td style="text-align: right;">9.43127</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">5665</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(maps)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mapdata)</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(us.cities)</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>or.cities <span class="ot">&lt;-</span> us.cities <span class="sc">%&gt;%</span> </span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(country.etc<span class="sc">==</span><span class="st">"OR"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">city =</span> <span class="fu">gsub</span>(<span class="st">" OR"</span>, <span class="st">""</span>, name)) <span class="sc">%&gt;%</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="sc">-</span>pop) <span class="sc">%&gt;%</span> </span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>(city <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Gresham"</span>, <span class="st">"Hillsboro"</span>, <span class="st">"Beaverton"</span>, <span class="st">"Springfield"</span>))) <span class="sc">%&gt;%</span> </span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>()</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the map data</span></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>states <span class="ot">&lt;-</span> <span class="fu">map_data</span>(<span class="st">"state"</span>) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(region <span class="sc">==</span> <span class="st">"oregon"</span>)</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Load your data</span></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(<span class="st">"../data/encoded_data_OR.csv"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(common_name <span class="sc">==</span> <span class="st">"Sharp-shinned Hawk"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(latitude, longitude)</span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> states) <span class="sc">+</span></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_polygon</span>(<span class="fu">aes</span>(<span class="at">x =</span> long, <span class="at">y =</span> lat, <span class="at">group =</span> group), </span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>               <span class="at">fill =</span> <span class="st">"#877778"</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> df, <span class="fu">aes</span>(<span class="at">x =</span> longitude, <span class="at">y =</span> latitude), </span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>             <span class="at">size=</span><span class="dv">1</span>, <span class="at">alpha=</span>.<span class="dv">5</span>, <span class="at">fill =</span> <span class="st">"red"</span>, <span class="at">shape=</span><span class="dv">21</span>) <span class="sc">+</span></span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> or.cities, <span class="fu">aes</span>(<span class="at">x=</span>long, <span class="at">y=</span>lat, <span class="at">label=</span>city), </span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>             <span class="at">fill=</span><span class="st">"#DDDDDD"</span>, <span class="at">color=</span><span class="st">"black"</span>, <span class="at">size=</span><span class="fl">3.5</span>, <span class="at">shape =</span> <span class="dv">21</span>,) <span class="sc">+</span> </span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">data =</span> or.cities, <span class="fu">aes</span>(<span class="at">x=</span>long, <span class="at">y=</span>lat, <span class="at">label=</span>city), </span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>            <span class="at">color=</span><span class="st">"white"</span>, <span class="at">hjust=</span>.<span class="dv">5</span>, <span class="at">vjust=</span><span class="fl">1.5</span>) <span class="sc">+</span> </span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_map</span>() <span class="sc">+</span></span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title=</span><span class="st">"Oregon Sharp-Shinned Hawk Observations, 2016-2019"</span>,</span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a>       <span class="at">plot.margin =</span> <span class="fu">unit</span>(<span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>), <span class="st">"cm"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="get_data_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="rasters-1" class="level3">
<h3 class="anchored" data-anchor-id="rasters-1">Rasters</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a data frame with all combinations of states and variables</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>pairs <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">state =</span> <span class="fu">c</span>(<span class="st">"CO"</span>, <span class="st">"NC"</span>, <span class="st">"OR"</span>, <span class="st">"VT"</span>),</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>                     <span class="at">variable =</span> <span class="fu">c</span>(<span class="st">"urban_imperviousness"</span>, <span class="st">"tmin"</span>, <span class="st">"tmax"</span>, <span class="st">"ppt"</span>, <span class="st">"soil"</span>, <span class="st">"Summer_NDVI"</span>,</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"Spring_NDVI"</span>, <span class="st">"Fall_NDVI"</span>, <span class="st">"Winter_NDVI"</span>, <span class="st">"Waterbody"</span>, <span class="st">"coastline"</span>, </span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"land_cover"</span>, <span class="st">"canopy"</span>, <span class="st">"dem"</span>))</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>min_max_scale <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>  (x <span class="sc">-</span> <span class="fu">min</span>(x, <span class="at">na.rm=</span>T)) <span class="sc">/</span> (<span class="fu">max</span>(x, <span class="at">na.rm=</span>T) <span class="sc">-</span> <span class="fu">min</span>(x, <span class="at">na.rm=</span>T))</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Create an empty list to store plots</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>plots_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Processing function for each pair</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>process_pair <span class="ot">&lt;-</span> <span class="cf">function</span>(state, variable) {</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>  variable <span class="ot">&lt;-</span> <span class="fu">as.character</span>(variable)</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (variable <span class="sc">==</span> <span class="st">"Waterbody"</span>) {</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>    fname <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"../data/rasters/"</span>, state, <span class="st">"_"</span>, variable, <span class="st">".tif"</span>)</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>    fname <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"../data/rasters/"</span>, variable, <span class="st">"_"</span>, state, <span class="st">".tif"</span>)</span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Load raster data</span></span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>  r <span class="ot">&lt;-</span> <span class="fu">raster</span>(fname)</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert the raster to a dataframe</span></span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(r, <span class="at">xy =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">value :=</span> <span class="fu">names</span>(.)[<span class="dv">3</span>]) <span class="sc">%&gt;%</span></span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">state =</span> state, <span class="at">variable =</span> variable) <span class="sc">%&gt;%</span></span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(value) <span class="sc">&amp;</span> <span class="sc">!</span>(variable <span class="sc">==</span> <span class="st">"land_cover"</span> <span class="sc">&amp;</span> value <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">128</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(variable) <span class="sc">%&gt;%</span></span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">value =</span> <span class="fu">min_max_scale</span>(value)) <span class="sc">%&gt;%</span></span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>()</span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df)</span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Process data</span></span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a>all_data <span class="ot">&lt;-</span> pairs <span class="sc">%&gt;%</span></span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pmap_df</span>(process_pair) </span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Create plots for each state</span></span>
<span id="cb35-44"><a href="#cb35-44" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (state <span class="cf">in</span> <span class="fu">c</span>(<span class="st">"CO"</span>, <span class="st">"NC"</span>, <span class="st">"OR"</span>, <span class="st">"VT"</span>)) {</span>
<span id="cb35-45"><a href="#cb35-45" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">filter</span>(all_data, state <span class="sc">==</span> <span class="sc">!!</span>state), <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">fill =</span> value)) <span class="sc">+</span></span>
<span id="cb35-46"><a href="#cb35-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_tile</span>() <span class="sc">+</span></span>
<span id="cb35-47"><a href="#cb35-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span>variable, <span class="at">scales=</span><span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb35-48"><a href="#cb35-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_cartesian</span>() <span class="sc">+</span> </span>
<span id="cb35-49"><a href="#cb35-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb35-50"><a href="#cb35-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb35-51"><a href="#cb35-51" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.text =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb35-52"><a href="#cb35-52" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.ticks =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb35-53"><a href="#cb35-53" aria-hidden="true" tabindex="-1"></a>          <span class="at">panel.grid.major =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb35-54"><a href="#cb35-54" aria-hidden="true" tabindex="-1"></a>          <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb35-55"><a href="#cb35-55" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb35-56"><a href="#cb35-56" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.margin =</span> <span class="fu">unit</span>(<span class="fu">c</span>(.<span class="dv">1</span>,.<span class="dv">1</span>,.<span class="dv">1</span>,.<span class="dv">1</span>), <span class="st">"cm"</span>)) <span class="sc">+</span></span>
<span id="cb35-57"><a href="#cb35-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste0</span>(state, <span class="st">" Rasters"</span>)) <span class="sc">+</span></span>
<span id="cb35-58"><a href="#cb35-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_gradient</span>(<span class="at">low =</span> <span class="st">"lightgrey"</span>, <span class="at">high =</span> <span class="st">"black"</span>) </span>
<span id="cb35-59"><a href="#cb35-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-60"><a href="#cb35-60" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add the plot to the list</span></span>
<span id="cb35-61"><a href="#cb35-61" aria-hidden="true" tabindex="-1"></a>  plots_list[[state]] <span class="ot">&lt;-</span> p</span>
<span id="cb35-62"><a href="#cb35-62" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-63"><a href="#cb35-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-64"><a href="#cb35-64" aria-hidden="true" tabindex="-1"></a><span class="co"># Print plots</span></span>
<span id="cb35-65"><a href="#cb35-65" aria-hidden="true" tabindex="-1"></a>plots_list<span class="sc">$</span>NC</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="get_data_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>